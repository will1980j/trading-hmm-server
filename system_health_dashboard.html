<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• System Health Dashboard - Real-time platform monitoring & diagnostics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #000; color: #fff; padding: 20px; }
        .nav { background: #111; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .nav a { color: #fff; text-decoration: none; padding: 8px 12px; border-radius: 5px; transition: background 0.2s; }
        .nav a:hover { background: #333; }
        h1 { font-size: 2em; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 30px; }
        .executive { background: #111; border: 1px solid #333; border-radius: 12px; padding: 30px; margin-bottom: 30px; text-align: center; }
        .health-score { font-size: 4em; font-weight: bold; margin: 20px 0; }
        .health-score.healthy { color: #00ff00; }
        .health-score.warning { color: #ffaa00; }
        .health-score.critical { color: #ff0000; }
        .alert-count { font-size: 1.5em; margin-top: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #111; border: 1px solid #333; border-radius: 12px; padding: 25px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 1.3em; font-weight: bold; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }
        .status-healthy { background: #00ff0020; color: #00ff00; border: 1px solid #00ff00; }
        .status-warning { background: #ffaa0020; color: #ffaa00; border: 1px solid #ffaa00; }
        .status-critical { background: #ff000020; color: #ff0000; border: 1px solid #ff0000; }
        .metric { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #222; }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: #aaa; }
        .metric-value { font-weight: bold; }
        .metric-value.good { color: #00ff00; }
        .metric-value.warn { color: #ffaa00; }
        .metric-value.bad { color: #ff0000; }
        .progress-bar { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; transition: width 0.3s; }
        .progress-fill.good { background: #00ff00; }
        .progress-fill.warn { background: #ffaa00; }
        .progress-fill.bad { background: #ff0000; }
        .module-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .module-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .module-card:hover { transform: translateY(-3px); border-color: #555; }
        .module-icon { font-size: 2em; margin-bottom: 10px; }
        .module-name { font-weight: bold; margin-bottom: 10px; }
        .module-status { font-size: 0.9em; }
        .alert-list { background: #111; border: 1px solid #333; border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .alert-item { background: #1a1a1a; border-left: 4px solid; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .alert-item.critical { border-color: #ff0000; }
        .alert-item.warning { border-color: #ffaa00; }
        .alert-item.info { border-color: #00aaff; }
        .alert-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .alert-title { font-weight: bold; }
        .alert-time { color: #888; font-size: 0.9em; }
        .last-updated { text-align: center; color: #666; margin-top: 30px; font-size: 0.9em; }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .module-grid { grid-template-columns: repeat(2, 1fr); }
            .nav { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/ml-dashboard">ü§ñ ML</a>
        <a href="/live-signals-dashboard">üì∂ Live</a>
        <a href="/signal-lab-dashboard">üè† Dashboard</a>
        <a href="/signal-analysis-lab">üß™ Signal Lab</a>
        <a href="/time-analysis">‚è∞ Time</a>
        <a href="/strategy-optimizer">üéØ Optimizer</a>
        <a href="/strategy-comparison">üèÜ Compare</a>
        <a href="/ai-business-advisor">üß† AI Advisor</a>
        <a href="/prop-portfolio">üíº Prop</a>
        <a href="/trade-manager">üìã Trades</a>
        <a href="/financial-summary">üí∞ Finance</a>
        <a href="/reporting-hub">üìä Reports</a>
        <a href="/system-health-dashboard" style="background: #333;">üè• Health</a>
    </div>

    <h1>üè• System Health Dashboard</h1>
    <p class="subtitle">Real-time platform monitoring & diagnostics</p>

    <div class="executive">
        <div>Overall System Health</div>
        <div class="health-score" id="overallScore">--</div>
        <div class="alert-count">
            <span id="criticalCount">0</span> Critical ¬∑ 
            <span id="warningCount">0</span> Warnings ¬∑ 
            <span id="healthyCount">0</span> Healthy
        </div>
    </div>

    <h2 style="margin-bottom: 15px;">üî¥ Critical Infrastructure</h2>
    <div class="grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title">TradingView Webhook</div>
                <span class="status-badge" id="webhookStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Signal Reception Rate</span>
                <span class="metric-value" id="signalRate">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">24h Signals Received</span>
                <span class="metric-value" id="signals24h">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Last Signal</span>
                <span class="metric-value" id="lastSignal">--</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Database Connection</div>
                <span class="status-badge" id="dbStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Connection Pool</span>
                <span class="metric-value" id="dbPool">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Query Performance</span>
                <span class="metric-value" id="dbQueryTime">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Active Connections</span>
                <span class="metric-value" id="dbConnections">--</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">API Performance</div>
                <span class="status-badge" id="apiStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg Response Time</span>
                <span class="metric-value" id="apiResponseTime">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Error Rate</span>
                <span class="metric-value" id="apiErrorRate">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Requests/min</span>
                <span class="metric-value" id="apiRequestRate">--</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">System Resources</div>
                <span class="status-badge" id="resourceStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Memory Usage</span>
                <span class="metric-value" id="memoryUsage">--</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="memoryBar"></div></div>
            <div class="metric">
                <span class="metric-label">CPU Usage</span>
                <span class="metric-value" id="cpuUsage">--</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="cpuBar"></div></div>
        </div>
    </div>

    <h2 style="margin-bottom: 15px;">ü§ñ ML Intelligence Hub Health</h2>
    <div class="grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Model Performance</div>
                <span class="status-badge" id="mlStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Model Accuracy</span>
                <span class="metric-value" id="mlAccuracy">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Health Score</span>
                <span class="metric-value" id="mlHealthScore">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Training Samples</span>
                <span class="metric-value" id="mlSamples">--</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Prediction Quality</div>
                <span class="status-badge" id="predictionStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg Confidence</span>
                <span class="metric-value" id="predictionConfidence">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Predictions Today</span>
                <span class="metric-value" id="predictionsToday">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Last Training</span>
                <span class="metric-value" id="lastTraining">--</span>
            </div>
        </div>
    </div>

    <h2 style="margin-bottom: 15px;">üìä Module Health Status</h2>
    <div class="module-grid" id="moduleGrid"></div>

    <h2 style="margin-bottom: 15px;">‚ö†Ô∏è Active Alerts</h2>
    <div class="alert-list" id="alertList"></div>

    <h2 style="margin-bottom: 15px;">üõ°Ô∏è Error Handling & Auto-Recovery</h2>
    <div class="grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Database Protection</div>
                <span class="status-badge status-healthy">üü¢ Active</span>
            </div>
            <div class="metric">
                <span class="metric-label">Error Handler</span>
                <span class="metric-value good">@auto_fix_db_errors</span>
            </div>
            <div class="metric">
                <span class="metric-label">Auto-Recovery</span>
                <span class="metric-value good">Health Monitor (30s)</span>
            </div>
            <div class="metric">
                <span class="metric-label">Features</span>
                <span class="metric-value" style="font-size: 0.85em;">Auto-rollback, Reconnect, Health checks</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Webhook Protection</div>
                <span class="status-badge status-warning">üü° Partial</span>
            </div>
            <div class="metric">
                <span class="metric-label">Error Handler</span>
                <span class="metric-value good">WebhookDebugger</span>
            </div>
            <div class="metric">
                <span class="metric-label">Auto-Recovery</span>
                <span class="metric-value warn">Manual Required</span>
            </div>
            <div class="metric">
                <span class="metric-label">Features</span>
                <span class="metric-value" style="font-size: 0.85em;">Logging, Status tracking</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">API Protection</div>
                <span class="status-badge status-healthy">üü¢ Active</span>
            </div>
            <div class="metric">
                <span class="metric-label">Error Handler</span>
                <span class="metric-value good">@app.before_request</span>
            </div>
            <div class="metric">
                <span class="metric-label">Auto-Recovery</span>
                <span class="metric-value good">Per-request reset</span>
            </div>
            <div class="metric">
                <span class="metric-label">Features</span>
                <span class="metric-value" style="font-size: 0.85em;">Transaction cleanup, Auto-rollback</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ML Protection</div>
                <span class="status-badge status-critical">üî¥ Basic</span>
            </div>
            <div class="metric">
                <span class="metric-label">Error Handler</span>
                <span class="metric-value bad">Try-catch only</span>
            </div>
            <div class="metric">
                <span class="metric-label">Auto-Recovery</span>
                <span class="metric-value bad">None</span>
            </div>
            <div class="metric">
                <span class="metric-label">Recommendation</span>
                <span class="metric-value" style="font-size: 0.85em; color: #ffaa00;">Add @auto_fix_db_errors</span>
            </div>
        </div>
    </div>

    <div class="last-updated">Last updated: <span id="lastUpdate">--</span> ¬∑ Auto-refresh: 30s</div>

    <script>
        let healthData = {};

        async function fetchHealthData() {
            try {
                const response = await fetch('/api/system-health');
                healthData = await response.json();
                updateDashboard();
            } catch (error) {
                console.error('Failed to fetch health data:', error);
            }
        }

        function updateDashboard() {
            const score = healthData.overall_score || 0;
            const scoreEl = document.getElementById('overallScore');
            scoreEl.textContent = score;
            scoreEl.className = 'health-score ' + (score >= 95 ? 'healthy' : score >= 90 ? 'warning' : 'critical');

            document.getElementById('criticalCount').textContent = healthData.critical_count || 0;
            document.getElementById('warningCount').textContent = healthData.warning_count || 0;
            document.getElementById('healthyCount').textContent = healthData.healthy_count || 0;

            updateCard('webhook', healthData.webhook || {});
            updateCard('database', healthData.database || {});
            updateCard('api', healthData.api || {});
            updateCard('resources', healthData.resources || {});
            updateCard('ml', healthData.ml || {});
            updateCard('prediction', healthData.prediction || {});

            updateModuleGrid(healthData.modules || []);
            updateAlerts(healthData.alerts || []);

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function updateCard(type, data) {
            const statusMap = { healthy: 'status-healthy', warning: 'status-warning', critical: 'status-critical' };
            const statusText = { healthy: 'üü¢ Healthy', warning: 'üü° Warning', critical: 'üî¥ Critical' };

            if (type === 'webhook') {
                setStatus('webhookStatus', data.status, statusMap, statusText);
                setMetric('signalRate', data.signal_rate, data.signal_rate_status);
                setMetric('signals24h', data.signals_24h);
                setMetric('lastSignal', data.last_signal);
            } else if (type === 'database') {
                setStatus('dbStatus', data.status, statusMap, statusText);
                setMetric('dbPool', data.pool_status);
                setMetric('dbQueryTime', data.query_time, data.query_time_status);
                setMetric('dbConnections', data.active_connections);
            } else if (type === 'api') {
                setStatus('apiStatus', data.status, statusMap, statusText);
                setMetric('apiResponseTime', data.response_time, data.response_time_status);
                setMetric('apiErrorRate', data.error_rate, data.error_rate_status);
                setMetric('apiRequestRate', data.request_rate);
            } else if (type === 'resources') {
                setStatus('resourceStatus', data.status, statusMap, statusText);
                setMetric('memoryUsage', data.memory_usage, data.memory_status);
                setMetric('cpuUsage', data.cpu_usage, data.cpu_status);
                setProgressBar('memoryBar', data.memory_percent, data.memory_status);
                setProgressBar('cpuBar', data.cpu_percent, data.cpu_status);
            } else if (type === 'ml') {
                setStatus('mlStatus', data.status, statusMap, statusText);
                setMetric('mlAccuracy', data.accuracy, data.accuracy_status);
                setMetric('mlHealthScore', data.health_score, data.health_score_status);
                setMetric('mlSamples', data.training_samples);
            } else if (type === 'prediction') {
                setStatus('predictionStatus', data.status, statusMap, statusText);
                setMetric('predictionConfidence', data.avg_confidence, data.confidence_status);
                setMetric('predictionsToday', data.predictions_today);
                setMetric('lastTraining', data.last_training);
            }
        }

        function setStatus(id, status, statusMap, statusText) {
            const el = document.getElementById(id);
            if (el && status) {
                el.className = 'status-badge ' + statusMap[status];
                el.textContent = statusText[status];
            }
        }

        function setMetric(id, value, status) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value || '--';
                if (status) {
                    el.className = 'metric-value ' + (status === 'healthy' ? 'good' : status === 'warning' ? 'warn' : 'bad');
                }
            }
        }

        function setProgressBar(id, percent, status) {
            const el = document.getElementById(id);
            if (el && percent !== undefined) {
                el.style.width = percent + '%';
                el.className = 'progress-fill ' + (status === 'healthy' ? 'good' : status === 'warning' ? 'warn' : 'bad');
            }
        }

        function updateModuleGrid(modules) {
            const grid = document.getElementById('moduleGrid');
            grid.innerHTML = modules.map(m => `
                <div class="module-card" onclick="window.location.href='${m.url}'">
                    <div class="module-icon">${m.icon}</div>
                    <div class="module-name">${m.name}</div>
                    <div class="module-status ${m.status === 'healthy' ? 'status-healthy' : m.status === 'warning' ? 'status-warning' : 'status-critical'}">
                        ${m.status === 'healthy' ? 'üü¢' : m.status === 'warning' ? 'üü°' : 'üî¥'} ${m.status_text}
                    </div>
                </div>
            `).join('');
        }

        function updateAlerts(alerts) {
            const list = document.getElementById('alertList');
            if (alerts.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #00ff00;">‚úÖ No active alerts - All systems operational</div>';
            } else {
                list.innerHTML = alerts.map(a => `
                    <div class="alert-item ${a.severity}">
                        <div class="alert-header">
                            <span class="alert-title">${a.severity === 'critical' ? 'üî¥' : a.severity === 'warning' ? 'üü°' : '‚ÑπÔ∏è'} ${a.title}</span>
                            <span class="alert-time">${a.time}</span>
                        </div>
                        <div>${a.message}</div>
                        ${a.auto_recovery ? `<div style="margin-top: 8px; padding: 8px; background: #1a1a1a; border-radius: 4px; font-size: 0.9em;">
                            <strong>üîÑ Auto-Recovery:</strong> ${a.auto_recovery}
                        </div>` : ''}
                    </div>
                `).join('');
            }
        }

        fetchHealthData();
        setInterval(fetchHealthData, 30000);
    </script>
</body>
</html>

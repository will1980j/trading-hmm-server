//@version=5
indicator("NQ Divergence Display", overlay=true, max_labels_count=20)

// Display settings
show_divergences = input.bool(true, "Show Divergence Alerts")
label_size = input.string("Normal", "Label Size", options=["Tiny", "Small", "Normal", "Large"])

get_label_size() =>
    switch label_size
        "Tiny" => size.tiny
        "Small" => size.small
        "Normal" => size.normal
        "Large" => size.large
        => size.normal

// Multiple alert conditions for different divergence types
alertcondition(true, title="DXY Bearish Divergence", message="DXY_BEARISH_DIVERGENCE")
alertcondition(true, title="DXY Bullish Divergence", message="DXY_BULLISH_DIVERGENCE") 
alertcondition(true, title="ES Bullish Divergence", message="ES_BULLISH_DIVERGENCE")
alertcondition(true, title="ES Bearish Divergence", message="ES_BEARISH_DIVERGENCE")
alertcondition(true, title="YM Bullish Divergence", message="YM_BULLISH_DIVERGENCE")
alertcondition(true, title="YM Bearish Divergence", message="YM_BEARISH_DIVERGENCE")

// Variables to track alerts
var int dxy_bearish_count = 0
var int dxy_bullish_count = 0
var int es_bullish_count = 0
var int es_bearish_count = 0
var int ym_bullish_count = 0
var int ym_bearish_count = 0

// Track last alert times to prevent duplicates
var int last_dxy_bearish = 0
var int last_dxy_bullish = 0
var int last_es_bullish = 0
var int last_es_bearish = 0
var int last_ym_bullish = 0
var int last_ym_bearish = 0

// DXY Bearish = NQ Long Opportunity
if barstate.isconfirmed and show_divergences and time != last_dxy_bearish
    // This triggers when DXY Bearish alert fires
    dxy_bearish_triggered = false // Set to true when alert fires
    
    if dxy_bearish_triggered
        last_dxy_bearish := time
        dxy_bearish_count := dxy_bearish_count + 1
        
        label.new(bar_index, low - (high-low)*0.2, 
                  "🟢 DXY DIVERGENCE\n━━━━━━━━━━━━━━━━━━━━\n📈 NQ LONG SETUP\n💰 DXY Bearish Signal\n⏰ " + str.format_time(time, "HH:mm", "America/New_York"),
                  color=color.new(#00ff88, 10), 
                  textcolor=color.white, 
                  style=label.style_label_up, 
                  size=get_label_size(),
                  tooltip="DXY Bearish → NQ Long Opportunity")

// DXY Bullish = NQ Short Opportunity  
if barstate.isconfirmed and show_divergences and time != last_dxy_bullish
    dxy_bullish_triggered = false // Set to true when alert fires
    
    if dxy_bullish_triggered
        last_dxy_bullish := time
        dxy_bullish_count := dxy_bullish_count + 1
        
        label.new(bar_index, high + (high-low)*0.2,
                  "🔴 DXY DIVERGENCE\n━━━━━━━━━━━━━━━━━━━━\n📉 NQ SHORT SETUP\n💰 DXY Bullish Signal\n⏰ " + str.format_time(time, "HH:mm", "America/New_York"),
                  color=color.new(#ff4757, 10),
                  textcolor=color.white,
                  style=label.style_label_down,
                  size=get_label_size(),
                  tooltip="DXY Bullish → NQ Short Opportunity")

// ES Bullish = NQ Long Opportunity
if barstate.isconfirmed and show_divergences and time != last_es_bullish
    es_bullish_triggered = false // Set to true when alert fires
    
    if es_bullish_triggered
        last_es_bullish := time
        es_bullish_count := es_bullish_count + 1
        
        label.new(bar_index, low - (high-low)*0.15,
                  "🟢 ES CORRELATION\n━━━━━━━━━━━━━━━━━━━━\n📈 NQ LONG SETUP\n💰 ES Bullish Signal\n⏰ " + str.format_time(time, "HH:mm", "America/New_York"),
                  color=color.new(#00ff88, 10),
                  textcolor=color.white,
                  style=label.style_label_up,
                  size=get_label_size(),
                  tooltip="ES Bullish → NQ Long Opportunity")

// Performance table
var table perf_table = table.new(position.top_right, 3, 4, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast
    total_divergences = dxy_bearish_count + dxy_bullish_count + es_bullish_count + es_bearish_count + ym_bullish_count + ym_bearish_count
    
    table.cell(perf_table, 0, 0, "🚨 DIVERGENCES", text_color=color.white, bgcolor=color.new(#1a1a2e, 0))
    table.cell(perf_table, 1, 0, "COUNT", text_color=color.white, bgcolor=color.new(#1a1a2e, 0))
    table.cell(perf_table, 2, 0, "DIRECTION", text_color=color.white, bgcolor=color.new(#1a1a2e, 0))
    
    table.cell(perf_table, 0, 1, "DXY Divergences", text_color=color.white)
    table.cell(perf_table, 1, 1, str.tostring(dxy_bearish_count + dxy_bullish_count), text_color=color.yellow)
    table.cell(perf_table, 2, 1, "INVERSE", text_color=color.orange)
    
    table.cell(perf_table, 0, 2, "ES/YM Correlations", text_color=color.white)
    table.cell(perf_table, 1, 2, str.tostring(es_bullish_count + es_bearish_count + ym_bullish_count + ym_bearish_count), text_color=color.yellow)
    table.cell(perf_table, 2, 2, "POSITIVE", text_color=color.lime)
    
    table.cell(perf_table, 0, 3, "Total Alerts", text_color=color.white)
    table.cell(perf_table, 1, 3, str.tostring(total_divergences), text_color=color.new(#00ff88, 0))
    table.cell(perf_table, 2, 3, "🌐 LIVE", text_color=color.new(#00ff88, 0))
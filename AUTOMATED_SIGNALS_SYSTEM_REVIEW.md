# AUTOMATED SIGNALS DASHBOARD - COMPLETE SYSTEM REVIEW

## SYSTEM OVERVIEW
Real-time trading signal dashboard that displays live MFE (Maximum Favorable Excursion) values for active trades. Signals are generated by a TradingView indicator and sent via webhooks to a Flask backend, stored in PostgreSQL, and displayed on a web dashboard.

---

## CORE COMPONENTS

### 1. TRADINGVIEW INDICATOR
**File:** `complete_automated_trading_system.pine`
**Purpose:** Generates trading signals and sends lifecycle webhooks

**Key Functions:**
- Signal detection (FVG/IFVG bias changes)
- Confirmation monitoring
- MFE tracking (dual: BE=1 and No BE strategies)
- Webhook transmission (ENTRY, MFE_UPDATE, BE_TRIGGERED, EXIT_SL, EXIT_BE)

**MFE Tracking Logic:**
- `signal_be_mfes` array: BE MFE (caps at +1R when BE triggered)
- `signal_mfes` array: No BE MFE (continues until stop hit)
- Sends MFE_UPDATE webhook every 60 seconds for active trades

**Webhook Payload (line 1262):**
```pinescript
f_buildPayload(EVENT_MFE_UPDATE, trade_id, direction, entry, stop, be_price, 
               risk_R, position_size, current_mfe_be, current_mfe_none, ...)
```

**Critical Fields:**
- `mfe_R`: BE MFE value
- `mae_R`: No BE MFE value (repurposed from MAE field)
- `event_type`: "MFE_UPDATE"
- `trade_id`: Format YYYYMMDD_HHMMSS000_DIRECTION

---

### 2. BACKEND API
**File:** `web_server.py`
**Key Endpoints:**

#### `/api/automated-signals/webhook` (POST)
**Function:** `automated_signals_webhook()` (line 12313)
**Purpose:** Receives TradingView webhooks
**Routes to:** `handle_mfe_update()` for MFE_UPDATE events

#### `/api/automated-signals/dashboard-data` (GET)
**Function:** `get_automated_signals_dashboard_data()` (line 14232)
**Purpose:** Returns active/completed trades with MFE values
**Query:** Uses CTE to aggregate latest MFE_UPDATE values

**CTE Logic (line 14248):**
```sql
WITH latest_mfe AS (
    SELECT trade_id,
           MAX(be_mfe) FILTER (WHERE event_type = 'MFE_UPDATE') AS latest_be_mfe,
           MAX(no_be_mfe) FILTER (WHERE event_type = 'MFE_UPDATE') AS latest_no_be_mfe
    FROM automated_signals
    GROUP BY trade_id
)
SELECT e.*, 
       COALESCE(m.latest_be_mfe, e.be_mfe, 0.0) AS be_mfe,
       COALESCE(m.latest_no_be_mfe, e.no_be_mfe, 0.0) AS no_be_mfe
FROM automated_signals e
LEFT JOIN latest_mfe m ON m.trade_id = e.trade_id
WHERE e.event_type = 'ENTRY' AND NOT EXISTS (EXIT events)
```

#### `handle_mfe_update()` (line 12728)
**Purpose:** Process MFE_UPDATE webhooks
**Logic:**
1. Extract BE MFE from `mfe_R` field
2. Extract No BE MFE from `mae_R` field (with fallback to `mfe_R`)
3. INSERT new MFE_UPDATE row (not UPDATE)
4. Broadcast via WebSocket

**Key Code (line 12755):**
```python
be_mfe = float(data.get('mfe_R') or 0)
no_be_mfe = float(data.get('mae_R') or data.get('mfe_R') or 0)
```

---

### 3. DATABASE
**Table:** `automated_signals`
**Schema:**
- `id`: Serial primary key
- `trade_id`: Unique trade identifier
- `event_type`: ENTRY | MFE_UPDATE | BE_TRIGGERED | EXIT_SL | EXIT_BE
- `direction`: LONG | SHORT
- `entry_price`: Entry price level
- `stop_loss`: Stop loss price level
- `be_mfe`: BE strategy MFE (R-multiple)
- `no_be_mfe`: No BE strategy MFE (R-multiple)
- `current_price`: Current market price
- `session`: Trading session
- `signal_date`: Date of signal
- `signal_time`: Time of signal
- `timestamp`: Event timestamp

**Event-Based Architecture:**
- Each webhook creates a NEW row
- Multiple rows per trade_id (one per lifecycle event)
- ENTRY row has 0.00 MFE values
- MFE_UPDATE rows have actual MFE values
- Dashboard aggregates latest MFE_UPDATE values

---

### 4. FRONTEND
**Template:** `templates/automated_signals_ultra.html`
**JavaScript:** `static/js/automated_signals_ultra.js`
**CSS:** `static/css/automated_signals_ultra.css`

**Data Flow:**
1. JavaScript calls `/api/automated-signals/dashboard-data` every 7 seconds
2. Receives JSON with active_trades and completed_trades arrays
3. Renders table with BE MFE and No BE MFE columns
4. WebSocket updates for real-time activity feed

**Fetch Logic (line 150):**
```javascript
fetch(`/api/automated-signals/dashboard-data?_=${Date.now()}`, {
    cache: 'no-store',
    headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate'
    }
})
```

---

## DATA FLOW

### Signal Lifecycle:
```
1. ENTRY webhook → Creates ENTRY row (be_mfe=0.0, no_be_mfe=0.0)
2. MFE_UPDATE webhook (every 60s) → Creates MFE_UPDATE row (be_mfe=X, no_be_mfe=Y)
3. Dashboard query → Aggregates latest MFE_UPDATE values via CTE
4. Dashboard displays → Shows live MFE values
```

### Webhook Format:
```json
{
  "trade_id": "20251202_165100000_BULLISH",
  "event_type": "MFE_UPDATE",
  "mfe_R": 0.739,
  "mae_R": 0.739,
  "current_price": 25600.0
}
```

---

## CURRENT ISSUE

**Problem:** Dashboard shows 0.00R for MFE values even though:
- Webhooks are being received (Railway logs confirm)
- MFE values are being stored (backend logs show storage)
- API returns correct values (test scripts show 1.8696R)
- Dashboard shows 0.00R (frontend display issue)

**Diagnosis:**
- ✅ Indicator sends webhooks correctly
- ✅ Backend receives and stores MFE values
- ✅ API endpoint returns correct data
- ❌ Dashboard displays 0.00R (caching or query issue)

**Recent Fixes Applied:**
1. Changed `handle_mfe_update` from UPDATE to INSERT (creates MFE_UPDATE rows)
2. Added CTE to dashboard query to aggregate MFE_UPDATE values
3. Updated indicator to send both BE and No BE MFE values
4. Added cache-busting to frontend fetch calls
5. Modified lifecycle validation to allow MFE_UPDATE after EXIT

---

## FILES TO REVIEW

### Critical Files:
1. `complete_automated_trading_system.pine` - TradingView indicator (line 1262 for MFE webhook)
2. `web_server.py` - Backend API
   - Line 12728: `handle_mfe_update()` function
   - Line 14232: `get_automated_signals_dashboard_data()` endpoint
3. `static/js/automated_signals_ultra.js` - Frontend JavaScript (line 150 for fetch)
4. `templates/automated_signals_ultra.html` - Dashboard HTML

### Supporting Files:
- `signal_normalization.py` - Payload normalization
- `automated_signals_state.py` - Alternative state builder (not currently used)
- `websocket_handler_robust.py` - WebSocket broadcasting

---

## TESTING

### Manual Test (WORKS):
```python
# test_mfe_update_webhook.py
payload = {
    "trade_id": "20251202_135100000_BULLISH",
    "event_type": "MFE_UPDATE",
    "mfe_R": 1.25,
    "current_price": 25625.0
}
# Result: MFE values stored and API returns 1.25R
```

### API Test (WORKS):
```bash
curl https://web-production-f8c3.up.railway.app/api/automated-signals/dashboard-data
# Returns: be_mfe: 1.8696, no_be_mfe: 1.8696
```

### Dashboard Test (FAILS):
- Browser shows 0.00R for all trades
- Hard refresh doesn't fix it
- Suggests frontend caching or query issue

---

## DEPLOYMENT INFO
- **Platform:** Railway (https://web-production-f8c3.up.railway.app)
- **Database:** PostgreSQL
- **Deployment:** GitHub auto-deploy (commit → push → Railway builds)
- **Typical deploy time:** 2-3 minutes

---

## NEXT STEPS FOR REVIEW
1. Verify CTE query is actually deployed on Railway
2. Check if dashboard-data endpoint is using the correct query
3. Verify frontend JavaScript is fetching and displaying API response correctly
4. Check for any caching layers between API and frontend
5. Verify MFE_UPDATE rows exist in database for active trades

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Signal Lab V2 - Dual Indicator Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .system-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #22c55e;
        }

        .status-warning {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
            color: #fbbf24;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.active { background: #22c55e; }
        .status-dot.warning { background: #fbbf24; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .price-tracker {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .current-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .price-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3b82f6;
        }

        .price-change {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .price-change.positive { color: #22c55e; }
        .price-change.negative { color: #ef4444; }

        .price-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .price-info-item {
            text-align: center;
        }

        .price-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #8b5cf6;
        }

        .price-info-label {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #22c55e;
        }

        .real-time-dot {
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .signals-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            grid-column: 1 / -1;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-color: #3b82f6;
        }

        .filter-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .signals-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .signals-table th,
        .signals-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .signals-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .signal-row {
            transition: background 0.2s;
        }

        .signal-row:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .signal-type {
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .signal-bullish {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .signal-bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .signal-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-awaiting {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .status-confirmed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .status-resolved {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .htf-alignment {
            display: flex;
            gap: 0.25rem;
        }

        .htf-badge {
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .htf-aligned {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .htf-neutral {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .candle-data {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .mfe-display {
            font-weight: 600;
            color: #8b5cf6;
        }

        .webhook-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .webhook-url {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            word-break: break-all;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .trades-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .trades-table th,
        .trades-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .trades-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: #94a3b8;
        }

        .trade-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .status-completed {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .bias-bullish {
            color: #22c55e;
            font-weight: 600;
        }

        .bias-bearish {
            color: #ef4444;
            font-weight: 600;
        }

        .r-targets {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .r-target {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #ffffff;
        }

        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .price-info {
                grid-template-columns: 1fr;
            }
            
            .signals-table {
                font-size: 0.8rem;
            }
            
            .signals-table th,
            .signals-table td {
                padding: 0.5rem;
            }
            
            .system-status {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .filter-tabs {
                order: 2;
            }
        }
    </style>
</head>
<body>
    <!-- Universal Navigation Bar -->
    <nav style="background: #141b3d; padding: 10px 15px; margin-bottom: 20px; border-bottom: 1px solid #2d3a5f; display: flex; gap: 4px; flex-wrap: wrap; align-items: center; justify-content: center;">
        <a href="/homepage" data-page="home" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🏠 Home</a>
        <a href="/signal-lab-dashboard" data-page="dashboard" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">📊 Dashboard</a>
        <a href="/signal-analysis-lab" data-page="lab" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🧪 Lab</a>
        <a href="/ml-dashboard" data-page="ml" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🤖 ML</a>

        <a href="/signal-lab-v2" data-page="v2" style="padding: 6px 10px; background: #3b82f6; color: white; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🤖 V2</a>
        <a href="/time-analysis" data-page="time" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">⏰ Time</a>
        <a href="/strategy-optimizer" data-page="strategy" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🎯 Strategy</a>
        <a href="/strategy-comparison" data-page="compare" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🏆 Compare</a>
        <a href="/ai-business-advisor" data-page="advisor" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🧠 AI</a>
        <a href="/prop-portfolio" data-page="portfolio" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">💼 Portfolio</a>
        <a href="/trade-manager" data-page="trades" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">📋 Trades</a>
        <a href="/financial-summary" data-page="finance" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">💰 Finance</a>
        <a href="/reporting-hub" data-page="reports" style="padding: 6px 10px; background: #1a2142; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">📊 Reports</a>
        <a href="/logout" data-page="logout" style="padding: 6px 10px; background: #dc2626; color: #f8fafc; text-decoration: none; border-radius: 5px; font-size: 12px; white-space: nowrap;">🚪 Logout</a>
    </nav>

    <div class="header">
        <h1>🚀 Enhanced Signal Lab V2 - Dual Indicator System</h1>
        <div class="system-status">
            <div class="status-indicator status-active" id="fvgStatus">
                <div class="status-dot active"></div>
                <span>Enhanced FVG</span>
            </div>
            <div class="status-indicator status-active" id="priceStatus">
                <div class="status-dot active"></div>
                <span>Price Stream</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Statistics Section -->
            <div class="stats-section">
                <h2 class="section-title">📊 System Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSignals">-</div>
                        <div class="stat-label">Total Signals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="awaitingConfirmation">-</div>
                        <div class="stat-label">Awaiting Confirmation</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeTrades">-</div>
                        <div class="stat-label">Active Trades</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todaySignals">-</div>
                        <div class="stat-label">Today's Signals</div>
                    </div>
                </div>
            </div>

            <!-- TradingView Real-Time Price Widget -->
            <div class="price-tracker">
                <h2 class="section-title">
                    📈 NASDAQ Real-Time Price
                    <span style="font-size: 0.7rem; color: #22c55e; margin-left: 0.5rem;">● LIVE</span>
                </h2>
                <!-- TradingView Widget BEGIN -->
                <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
                    <div class="tradingview-widget-container__widget" style="height: calc(100% - 32px); width: 100%;"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                    {
                        "symbol": "CME_MINI:NQ1!",
                        "width": "100%",
                        "height": "100%",
                        "locale": "en",
                        "dateRange": "1D",
                        "colorTheme": "dark",
                        "trendLineColor": "rgba(41, 98, 255, 1)",
                        "underLineColor": "rgba(41, 98, 255, 0.3)",
                        "underLineBottomColor": "rgba(41, 98, 255, 0)",
                        "isTransparent": true,
                        "autosize": true,
                        "largeChartUrl": ""
                    }
                    </script>
                </div>
                <!-- TradingView Widget END -->
            </div>
        </div>

        <!-- Enhanced Signals Section -->
        <div class="signals-section">
            <div class="section-header">
                <h2 class="section-title">🎯 Enhanced FVG Signals</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-filter="all">All</div>
                        <div class="filter-tab" data-filter="awaiting">Awaiting</div>
                        <div class="filter-tab" data-filter="confirmed">Confirmed</div>
                        <div class="filter-tab" data-filter="resolved">Resolved</div>
                    </div>
                    <a href="/signal-analysis-lab" class="nav-link">📋 Manual Lab</a>
                    <button class="refresh-btn" onclick="loadEnhancedSignals()">🔄 Refresh</button>
                </div>
            </div>

            <div id="signalsContainer">
                <div class="loading">
                    <p>Loading enhanced signals...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let priceUpdateCount = 0;
        let lastMinute = new Date().getMinutes();
        let consecutiveFailures = 0;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStats();
            loadCurrentPrice();
            loadEnhancedSignals();
            
            // Set up filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    loadEnhancedSignals();
                });
            });
            
            // Auto-refresh every 10 seconds
            setInterval(() => {
                loadSystemStats();
                loadCurrentPrice();
                loadEnhancedSignals();
            }, 10000);
            
            // Update price more frequently - but only if data is available
            let pricePollingInterval = setInterval(async () => {
                const hasData = await loadCurrentPrice();
                // If no data available for 5 consecutive attempts, reduce polling frequency
                if (!hasData) {
                    consecutiveFailures++;
                    if (consecutiveFailures >= 5) {
                        clearInterval(pricePollingInterval);
                        // Check again every 30 seconds instead of every 2 seconds
                        setInterval(loadCurrentPrice, 30000);
                    }
                } else {
                    consecutiveFailures = 0;
                }
            }, 2000);
        });

        async function loadSystemStats() {
            try {
                // Use existing V2 stats endpoint
                const response = await fetch('/api/v2/stats');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Use existing stats format
                    document.getElementById('totalSignals').textContent = data.total_signals || 0;
                    document.getElementById('awaitingConfirmation').textContent = data.pending_trades || 0;
                    document.getElementById('activeTrades').textContent = data.active_trades || 0;
                    document.getElementById('todaySignals').textContent = data.today_signals || 0;
                } else {
                    console.log('Stats endpoint not available, using defaults');
                    setDefaultStats();
                }
            } catch (error) {
                console.error('Error loading system stats:', error);
                setDefaultStats();
            }
        }

        function setDefaultStats() {
            document.getElementById('totalSignals').textContent = '0';
            document.getElementById('awaitingConfirmation').textContent = '0';
            document.getElementById('activeTrades').textContent = '0';
            document.getElementById('todaySignals').textContent = '0';
        }

        async function loadCurrentPrice() {
            try {
                // Try to get real price data from endpoints
                let response = await fetch('/api/v2/price/current');
                if (!response.ok) {
                    response = await fetch('/api/v2/price/stream?limit=1');
                }
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Check if API returned no_data status
                    if (data.status === 'no_data' || data.status === 'system_error') {
                        console.log(`📊 No price data available: ${data.message}`);
                        showMarketClosedState();
                        return false;
                    }
                    
                    let priceData = null;
                    
                    // Handle direct price data from /api/v2/price/current
                    if (data.price) {
                        priceData = data;
                    }
                    // Handle price stream data from /api/v2/price/stream
                    else if (data.prices && data.prices.length > 0) {
                        priceData = data.prices[0];
                    }
                    // Legacy format support
                    else if (data.current_price) {
                        priceData = data.current_price;
                    }
                    
                    if (priceData) {
                        // CHECK FOR STALE DATA OR INVALID SESSION
                        const session = priceData.session || 'Unknown';
                        const timestamp = priceData.timestamp || priceData.created_at;
                        const lastUpdate = new Date(timestamp);
                        const now = new Date();
                        const ageMinutes = (now - lastUpdate) / 1000 / 60;
                        
                        // REJECT STALE DATA (>5 minutes old) OR INVALID SESSION
                        if (session === 'INVALID' || ageMinutes > 5) {
                            console.log(`🚫 Rejecting stale/invalid price data: session=${session}, age=${ageMinutes.toFixed(1)}min`);
                            showMarketClosedState();
                            return false;
                        }
                        
                        // VALID FRESH DATA - DISPLAY IT
                        document.getElementById('currentPrice').textContent = parseFloat(priceData.price).toFixed(2);
                        
                        const change = priceData.change || 0;
                        const changeElement = document.getElementById('priceChange');
                        changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}`;
                        changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
                        
                        document.getElementById('currentSession').textContent = session;
                        document.getElementById('lastUpdate').textContent = lastUpdate.toLocaleTimeString();
                        
                        // Update price update counter only with real data
                        const currentMinute = new Date().getMinutes();
                        if (currentMinute !== lastMinute) {
                            priceUpdateCount = 1;
                            lastMinute = currentMinute;
                        } else {
                            priceUpdateCount++;
                        }
                        document.getElementById('priceUpdates').textContent = priceUpdateCount;
                        
                        updateStatusIndicator('priceStatus', true);
                        return true; // Successfully got real data
                    } else {
                        // No real data available - show market closed state
                        showMarketClosedState();
                        return false; // No real data available
                    }
                } else {
                    // No price endpoint available - show market closed state
                    showMarketClosedState();
                    return false; // No endpoint available
                }
                
            } catch (error) {
                console.error('Error loading current price:', error);
                showMarketClosedState();
                return false; // Error occurred
            }
        }

        function showMarketClosedState() {
            // Determine if market is actually closed or just waiting for data
            const now = new Date();
            const hour = now.getHours();
            
            // Check if we're in INVALID session (16:00-19:59 EST = 20:00-23:59 UTC in winter, 21:00-00:59 UTC in summer)
            // For simplicity, check local hour - if between 4PM-8PM EST, market is closed
            const isAfterHours = (hour >= 16 && hour < 20);
            
            document.getElementById('currentPrice').textContent = '---.--';
            document.getElementById('priceChange').textContent = '--';
            document.getElementById('priceChange').className = 'price-change';
            
            if (isAfterHours) {
                // Actually after hours
                document.getElementById('currentSession').textContent = 'CLOSED';
                document.getElementById('lastUpdate').textContent = 'After Hours';
                document.getElementById('priceUpdates').textContent = '0';
                updateStatusIndicator('priceStatus', false);
                
                const statusElement = document.querySelector('.status-indicator');
                if (statusElement) {
                    statusElement.classList.remove('status-active');
                    statusElement.classList.add('status-warning');
                    const statusText = statusElement.querySelector('span:last-child');
                    if (statusText) statusText.textContent = 'Market Closed';
                }
            } else {
                // Market is open, just waiting for data
                document.getElementById('currentSession').textContent = 'WAITING';
                document.getElementById('lastUpdate').textContent = 'No data yet';
                document.getElementById('priceUpdates').textContent = '0';
                updateStatusIndicator('priceStatus', false);
                
                const statusElement = document.querySelector('.status-indicator');
                if (statusElement) {
                    statusElement.classList.remove('status-active');
                    statusElement.classList.add('status-warning');
                    const statusText = statusElement.querySelector('span:last-child');
                    if (statusText) statusText.textContent = 'Waiting for Price Data';
                }
            }
        }

        async function loadEnhancedSignals() {
            try {
                // Try to get V2 trades from existing endpoint
                const response = await fetch('/api/v2/active-trades');
                const container = document.getElementById('signalsContainer');
                
                if (response.ok) {
                    const data = await response.json();
                    let signals = data.trades || [];
                    
                    // Apply filter (adapt to existing data structure)
                    if (currentFilter !== 'all') {
                        signals = signals.filter(signal => {
                            switch (currentFilter) {
                                case 'awaiting': return signal.trade_status === 'pending_confirmation';
                                case 'confirmed': return signal.trade_status === 'active';
                                case 'resolved': return signal.trade_status === 'completed';
                                default: return true;
                            }
                        });
                    }
                    
                    if (signals.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <h3>🎯 Enhanced FVG System Ready</h3>
                                <p>Enhanced signals will appear here when received from TradingView.</p>
                                <div class="webhook-info">
                                    <strong>Enhanced FVG Webhook:</strong>
                                    <div class="webhook-url">https://web-production-cd33.up.railway.app/api/live-signals-v2</div>
                                </div>
                            </div>
                        `;
                        updateStatusIndicator('fvgStatus', false);
                        return;
                    }
                    
                    let tableHTML = `
                        <table class="signals-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date/Time</th>
                                    <th>Type</th>
                                    <th>Session</th>
                                    <th>Status</th>
                                    <th>Entry Price</th>
                                    <th>Stop Loss</th>
                                    <th>R-Targets</th>
                                    <th>MFE</th>
                                    <th>Automation</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    signals.forEach(signal => {
                        const statusClass = getStatusClassV1(signal.trade_status);
                        const typeClass = signal.bias === 'Bullish' ? 'signal-bullish' : 'signal-bearish';
                        
                        tableHTML += `
                            <tr class="signal-row">
                                <td>${signal.id}</td>
                                <td>${formatDateTimeV1(signal.date, signal.time)}</td>
                                <td><span class="signal-type ${typeClass}">${signal.bias}</span></td>
                                <td>${signal.session}</td>
                                <td><span class="signal-status ${statusClass}">${formatStatusV1(signal.trade_status)}</span></td>
                                <td>${formatPriceV1(signal.entry_price)}</td>
                                <td>${formatPriceV1(signal.stop_loss_price)}</td>
                                <td>${formatRTargetsV1(signal)}</td>
                                <td><span class="mfe-display">${formatMFEV1(signal.current_mfe)}</span></td>
                                <td>enhanced_v2</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table>';
                    container.innerHTML = tableHTML;
                    
                    // Update FVG status indicator
                    updateStatusIndicator('fvgStatus', true);
                    
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>🎯 Enhanced FVG System Ready</h3>
                            <p>Enhanced signals will appear here when received from TradingView.</p>
                            <div class="webhook-info">
                                <strong>Enhanced FVG Webhook:</strong>
                                <div class="webhook-url">https://web-production-cd33.up.railway.app/api/live-signals-v2</div>
                            </div>
                        </div>
                    `;
                    updateStatusIndicator('fvgStatus', false);
                }
                
            } catch (error) {
                console.error('Error loading enhanced signals:', error);
                document.getElementById('signalsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>🎯 Enhanced FVG System Ready</h3>
                        <p>System is ready to receive signals from your TradingView alerts.</p>
                        <div class="webhook-info">
                            <strong>Enhanced FVG Webhook:</strong>
                            <div class="webhook-url">https://web-production-cd33.up.railway.app/api/live-signals-v2</div>
                        </div>
                    </div>
                `;
                updateStatusIndicator('fvgStatus', true); // Show as ready
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'pending_confirmation': return 'status-pending';
                case 'active': return 'status-active';
                case 'completed': return 'status-completed';
                default: return 'status-pending';
            }
        }

        function formatStatus(status) {
            switch (status) {
                case 'pending_confirmation': return 'Pending';
                case 'active': return 'Active';
                case 'completed': return 'Completed';
                default: return status;
            }
        }

        function formatDateTime(date, time) {
            if (!date || !time) return 'N/A';
            return `${date} ${time}`;
        }

        function formatPrice(price) {
            if (!price) return 'Pending';
            return `$${parseFloat(price).toFixed(2)}`;
        }

        function formatRTargets(trade) {
            const targets = [];
            if (trade.target_1r_price) targets.push('1R');
            if (trade.target_2r_price) targets.push('2R');
            if (trade.target_3r_price) targets.push('3R');
            if (trade.target_5r_price) targets.push('5R');
            if (trade.target_10r_price) targets.push('10R');
            if (trade.target_20r_price) targets.push('20R');
            
            if (targets.length === 0) return 'Pending';
            
            return targets.map(target => `<span class="r-target">${target}</span>`).join('');
        }

        function formatMFE(mfe) {
            if (!mfe || mfe === 0) return '0.00R';
            return `${parseFloat(mfe).toFixed(2)}R`;
        }
        function updateStatusIndicator(elementId, isActive) {
            const element = document.getElementById(elementId);
            if (isActive) {
                element.className = 'status-indicator status-active';
                element.querySelector('.status-dot').className = 'status-dot active';
                
                // Show LIVE indicator only when price data is actually live
                if (elementId === 'priceStatus') {
                    document.getElementById('liveIndicator').style.display = 'inline-flex';
                }
            } else {
                element.className = 'status-indicator status-warning';
                element.querySelector('.status-dot').className = 'status-dot warning';
                
                // Hide LIVE indicator when no real data
                if (elementId === 'priceStatus') {
                    document.getElementById('liveIndicator').style.display = 'none';
                }
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function getStatusClass(status) {
            switch (status) {
                case 'awaiting_confirmation': return 'status-awaiting';
                case 'confirmed': return 'status-confirmed';
                case 'resolved': return 'status-resolved';
                default: return 'status-awaiting';
            }
        }

        function formatStatus(status) {
            switch (status) {
                case 'awaiting_confirmation': return 'Awaiting';
                case 'confirmed': return 'Confirmed';
                case 'resolved': return 'Resolved';
                default: return status;
            }
        }

        function formatCandleData(candle) {
            if (!candle || !candle.close) return 'N/A';
            return `<div class="candle-data">
                O: ${parseFloat(candle.open || 0).toFixed(2)}<br>
                H: ${parseFloat(candle.high || 0).toFixed(2)}<br>
                L: ${parseFloat(candle.low || 0).toFixed(2)}<br>
                C: ${parseFloat(candle.close || 0).toFixed(2)}
            </div>`;
        }

        function formatHTFAlignment(signal) {
            // This would be populated from the enhanced signal data
            return `<div class="htf-alignment">
                <span class="htf-badge htf-aligned">1H</span>
                <span class="htf-badge htf-aligned">15M</span>
                <span class="htf-badge htf-aligned">5M</span>
            </div>`;
        }

        function formatEntryStop(tradeData) {
            if (!tradeData) return 'Pending';
            
            const entry = tradeData.entry_price ? parseFloat(tradeData.entry_price).toFixed(2) : 'Pending';
            const stop = tradeData.stop_loss_price ? parseFloat(tradeData.stop_loss_price).toFixed(2) : 'Pending';
            
            return `Entry: ${entry}<br>Stop: ${stop}`;
        }

        function formatMFE(tradeData) {
            if (!tradeData) return '0.00R';
            
            const currentMFE = tradeData.current_mfe || 0;
            const maxMFE = tradeData.max_mfe || 0;
            
            return `${parseFloat(currentMFE).toFixed(2)}R<br><small>Max: ${parseFloat(maxMFE).toFixed(2)}R</small>`;
        }

        // V1 compatibility functions for existing data structure
        function getStatusClassV1(status) {
            switch (status) {
                case 'pending_confirmation': return 'status-awaiting';
                case 'active': return 'status-confirmed';
                case 'completed': return 'status-resolved';
                default: return 'status-awaiting';
            }
        }

        function formatStatusV1(status) {
            switch (status) {
                case 'pending_confirmation': return 'Awaiting';
                case 'active': return 'Active';
                case 'completed': return 'Completed';
                default: return status;
            }
        }

        function formatDateTimeV1(date, time) {
            if (!date) return 'N/A';
            return `${date}${time ? ' ' + time : ''}`;
        }

        function formatPriceV1(price) {
            if (!price || price === 0) return 'Pending';
            return parseFloat(price).toFixed(2);
        }

        function formatRTargetsV1(trade) {
            const targets = [];
            if (trade.target_1r_price) targets.push('1R');
            if (trade.target_2r_price) targets.push('2R');
            if (trade.target_3r_price) targets.push('3R');
            if (trade.target_5r_price) targets.push('5R');
            if (trade.target_10r_price) targets.push('10R');
            if (trade.target_20r_price) targets.push('20R');
            
            if (targets.length === 0) return 'Pending';
            
            return targets.map(target => `<span class="htf-badge htf-aligned">${target}</span>`).join(' ');
        }

        function formatMFEV1(mfe) {
            if (!mfe || mfe === 0) return '0.00R';
            return `${parseFloat(mfe).toFixed(2)}R`;
        }
    </script>
</body>
</html>
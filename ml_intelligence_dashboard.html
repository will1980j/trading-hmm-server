<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Intelligence Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00ff88;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #00ff88;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            opacity: 0.7;
        }
        
        .metric-value {
            font-weight: bold;
            color: #00ff88;
        }
        
        .recommendation {
            background: rgba(0,255,136,0.1);
            border-left: 3px solid #00ff88;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        
        .button:hover {
            background: #00dd77;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-trained {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
        }
        
        .status-not-trained {
            background: rgba(255,165,2,0.2);
            color: #ffa502;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 20px;">
            <a href="/live-signals-dashboard" style="color: #00ff88; text-decoration: none; margin-right: 15px;">üì∂ Live Signals</a>
            <a href="/signal-analysis-lab" style="color: #00ff88; text-decoration: none; margin-right: 15px;">üìä 1M Signal Lab</a>
            <a href="/signal-analysis-5m" style="color: #00ff88; text-decoration: none; margin-right: 15px;">üìà 5M Signal Lab</a>
            <a href="/signal-analysis-15m" style="color: #00ff88; text-decoration: none; margin-right: 15px;">üìà 15M Signal Lab</a>
            <a href="/signal-lab-dashboard" style="color: #00ff88; text-decoration: none; margin-right: 15px;">üè† Dashboard</a>
            <a href="/trade-manager" style="color: #00ff88; text-decoration: none;">üíº Trade Manager</a>
        </div>
        
        <h1>ü§ñ ML Intelligence Dashboard</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="button" onclick="trainML()">Train ML Models</button>
            <button class="button" onclick="refreshInsights()">Refresh Insights</button>
        </div>
        
        <div id="loading" class="loading">Loading ML insights...</div>
        
        <div id="content" style="display: none;">
            <div class="grid">
                <div class="card">
                    <h2>üìä ML Status</h2>
                    <div class="metric">
                        <span class="metric-label">Status:</span>
                        <span id="mlStatus" class="status">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Training Samples:</span>
                        <span class="metric-value" id="trainingSamples">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last Training:</span>
                        <span class="metric-value" id="lastTraining">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Models:</span>
                        <span class="metric-value" id="modelsCount">--</span>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üéØ Best Session</h2>
                    <div class="metric">
                        <span class="metric-label">Session:</span>
                        <span class="metric-value" id="bestSession">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg MFE:</span>
                        <span class="metric-value" id="sessionMFE">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Trade Count:</span>
                        <span class="metric-value" id="sessionCount">--</span>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìà Best Signal Type</h2>
                    <div class="metric">
                        <span class="metric-label">Signal:</span>
                        <span class="metric-value" id="bestSignal">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg MFE:</span>
                        <span class="metric-value" id="signalMFE">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Trade Count:</span>
                        <span class="metric-value" id="signalCount">--</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üéØ Optimal R Targets</h2>
                <div id="targets"></div>
            </div>
            
            <div class="card">
                <h2>üìä Bias Performance</h2>
                <div id="biasPerformance"></div>
            </div>
            
            <div class="card">
                <h2>üí° Key Recommendations</h2>
                <div id="recommendations"></div>
            </div>
        </div>
    </div>

    <script>
        async function loadMLInsights() {
            try {
                const response = await fetch('/api/ml-insights');
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Update ML status
                const perf = data.performance || {};
                const isTrained = perf.is_trained;
                
                document.getElementById('mlStatus').textContent = isTrained ? 'Trained' : 'Not Trained';
                document.getElementById('mlStatus').className = isTrained ? 'status status-trained' : 'status status-not-trained';
                document.getElementById('trainingSamples').textContent = perf.training_samples || 0;
                document.getElementById('lastTraining').textContent = perf.last_training ? new Date(perf.last_training).toLocaleString() : 'Never';
                document.getElementById('modelsCount').textContent = perf.models_available ? perf.models_available.length : 0;
                
                // Update insights
                const insights = data.insights || {};
                
                // Best session
                if (insights.best_sessions) {
                    const bs = insights.best_sessions;
                    document.getElementById('bestSession').textContent = bs.best_session || '--';
                    document.getElementById('sessionMFE').textContent = bs.avg_mfe ? bs.avg_mfe.toFixed(2) + 'R' : '--';
                    document.getElementById('sessionCount').textContent = bs.trade_count || '--';
                }
                
                // Best signal
                if (insights.best_signal_types) {
                    const sig = insights.best_signal_types;
                    document.getElementById('bestSignal').textContent = sig.best_signal_type || '--';
                    document.getElementById('signalMFE').textContent = sig.avg_mfe ? sig.avg_mfe.toFixed(2) + 'R' : '--';
                    document.getElementById('signalCount').textContent = sig.trade_count || '--';
                }
                
                // Optimal targets
                if (insights.optimal_targets) {
                    const targetsHTML = Object.entries(insights.optimal_targets)
                        .map(([target, data]) => `
                            <div class="metric">
                                <span class="metric-label">${target}:</span>
                                <span class="metric-value">${data.hit_rate.toFixed(1)}% hit rate (${data.avg_when_hit.toFixed(2)}R avg)</span>
                            </div>
                        `).join('');
                    document.getElementById('targets').innerHTML = targetsHTML;
                }
                
                // Bias performance
                if (insights.bias_performance) {
                    const bias = insights.bias_performance;
                    const biasHTML = `
                        <div class="metric">
                            <span class="metric-label">Bullish:</span>
                            <span class="metric-value">${bias.bullish.avg_mfe.toFixed(2)}R (${bias.bullish.count} trades)</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Bearish:</span>
                            <span class="metric-value">${bias.bearish.avg_mfe.toFixed(2)}R (${bias.bearish.count} trades)</span>
                        </div>
                    `;
                    document.getElementById('biasPerformance').innerHTML = biasHTML;
                }
                
                // Recommendations
                if (insights.key_recommendations) {
                    const recsHTML = insights.key_recommendations
                        .map(rec => `<div class="recommendation">${rec}</div>`)
                        .join('');
                    document.getElementById('recommendations').innerHTML = recsHTML || '<p>No recommendations available</p>';
                }
                
            } catch (error) {
                console.error('Error loading ML insights:', error);
                document.getElementById('loading').textContent = 'Error loading insights: ' + error.message;
            }
        }
        
        async function trainML() {
            if (!confirm('Train ML models on all trading data? This may take a minute.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/ml-train', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert(`‚úÖ ML Training Complete!\n\nSamples: ${data.training_samples}\nAccuracy: ${data.success_accuracy.toFixed(1)}%\nMAE: ${data.mfe_mae.toFixed(3)}R`);
                    loadMLInsights();
                } else {
                    alert('‚ùå Training failed: ' + (data.message || data.error));
                }
            } catch (error) {
                alert('‚ùå Training error: ' + error.message);
            }
        }
        
        function refreshInsights() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            loadMLInsights();
        }
        
        // Load on page load
        loadMLInsights();
        
        // Auto-refresh every 5 minutes
        setInterval(loadMLInsights, 300000);
    </script>
</body>
</html>

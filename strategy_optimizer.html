<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Optimizer - Find Your Best Trade Setup</title>
    <link rel="stylesheet" href="/style_preload.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .navbar {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            padding: 10px 18px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1);
            display: inline-block;
            margin: 0 5px;
        }
        
        .nav-link:hover { background: rgba(255,255,255,0.15); }
        .nav-link.active { color: #00ff88; background: rgba(0,255,136,0.15); border-color: rgba(0,255,136,0.3); }
        
        .header {
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .controls {
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #00ff88;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }
        
        .session-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .session-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
        }
        
        .session-item input { width: 16px; height: 16px; accent-color: #00ff88; }
        
        .btn {
            background: linear-gradient(45deg, #00ff88, #00d4aa);
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
            transition: all 0.3s ease;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,255,136,0.4); }
        
        .result-card {
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid rgba(0,255,136,0.3);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .result-title {
            font-size: 28px;
            font-weight: 800;
            color: #00ff88;
        }
        
        .score-badge {
            background: linear-gradient(45deg, #00ff88, #00d4aa);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: 700;
            color: #000;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .metric-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(45deg, #00ff88, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .metric-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.8;
            font-weight: 600;
        }
        
        .strategy-details {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .detail-label { opacity: 0.8; }
        .detail-value { font-weight: 600; color: #00ff88; }
        
        .warning-box {
            background: rgba(255,71,87,0.1);
            border: 1px solid rgba(255,71,87,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            color: #ff4757;
        }
        
        .success-box {
            background: rgba(0,255,136,0.1);
            border: 1px solid rgba(0,255,136,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            color: #00ff88;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .comparison-table th {
            background: rgba(0,255,136,0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #00ff88;
            border-bottom: 2px solid rgba(0,255,136,0.3);
        }
        
        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: rgba(255,255,255,0.7);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div style="display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap;">
            <a href="/ml-dashboard" class="nav-link">ü§ñ ML</a>
            <a href="/live-signals-dashboard" class="nav-link">üì∂ Live</a>
            <a href="/signal-lab-dashboard" class="nav-link">üè† Dashboard</a>
            <a href="/signal-analysis-lab" class="nav-link">üìä Signal Lab</a>
            <a href="/strategy-optimizer" class="nav-link active">üéØ Optimizer</a>
            <a href="/ai-business-advisor" class="nav-link">üß† AI Advisor</a>
            <a href="/trade-manager" class="nav-link">üìã Trades</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="header">
            <h1>üéØ Strategy Optimizer</h1>
            <p>Find the single best way to trade with prop firm constraints applied</p>
        </div>
        
        <div class="controls">
            <h3 style="color: #00ff88; margin-bottom: 20px;">Prop Firm Constraints</h3>
            <div class="control-grid">
                <div class="control-group">
                    <label>Max Consecutive Losses</label>
                    <input type="number" id="maxConsecLosses" value="5" min="1" max="10">
                </div>
                <div class="control-group">
                    <label>Max Drawdown (%)</label>
                    <input type="number" id="maxDrawdown" value="10" min="5" max="20" step="1">
                </div>
                <div class="control-group">
                    <label>Risk Per Trade (%)</label>
                    <input type="number" id="riskPerTrade" value="0.5" min="0.1" max="2" step="0.1">
                </div>
                <div class="control-group">
                    <label>Min Win Rate (%)</label>
                    <input type="number" id="minWinRate" value="40" min="0" max="100" step="5">
                </div>
            </div>
            
            <h3 style="color: #00ff88; margin: 20px 0;">Session Selection</h3>
            <div class="session-grid">
                <div class="session-item">
                    <input type="checkbox" id="sessAsia" value="Asia" checked>
                    <label for="sessAsia">Asia</label>
                </div>
                <div class="session-item">
                    <input type="checkbox" id="sessLondon" value="London" checked>
                    <label for="sessLondon">London</label>
                </div>
                <div class="session-item">
                    <input type="checkbox" id="sessNYPre" value="NY Pre Market" checked>
                    <label for="sessNYPre">NY Pre Market</label>
                </div>
                <div class="session-item">
                    <input type="checkbox" id="sessNYAM" value="NY AM" checked>
                    <label for="sessNYAM">NY AM</label>
                </div>
                <div class="session-item">
                    <input type="checkbox" id="sessNYLunch" value="NY Lunch" checked>
                    <label for="sessNYLunch">NY Lunch</label>
                </div>
                <div class="session-item">
                    <input type="checkbox" id="sessNYPM" value="NY PM" checked>
                    <label for="sessNYPM">NY PM</label>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn" onclick="runOptimization()">üöÄ Find Optimal Strategy</button>
            </div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let signals = [];
        
        async function loadSignals() {
            try {
                const response = await fetch('https://web-production-cd33.up.railway.app/api/signal-lab-trades?analysis_only=true');
                if (!response.ok) throw new Error('Failed to load data');
                
                const data = await response.json();
                const trades = Array.isArray(data) ? data : data.trades || [];
                
                signals = trades.filter(trade => {
                    const date = new Date(trade.date);
                    const dayOfWeek = date.getDay();
                    return dayOfWeek !== 0 && dayOfWeek !== 6;
                }).map(trade => ({
                    date: trade.date,
                    time: trade.time,
                    session: trade.session,
                    mfeNone: parseFloat(trade.mfe_none || trade.mfe) || 0,
                    mfe1: parseFloat(trade.mfe1) || 0
                }));
                
                console.log(`Loaded ${signals.length} signals`);
            } catch (error) {
                console.error('Error loading signals:', error);
                document.getElementById('results').innerHTML = `<div class="warning-box">Failed to load trading data: ${error.message}</div>`;
            }
        }
        
        function getSelectedSessions() {
            return ['sessAsia', 'sessLondon', 'sessNYPre', 'sessNYAM', 'sessNYLunch', 'sessNYPM']
                .filter(id => document.getElementById(id).checked)
                .map(id => document.getElementById(id).value);
        }
        
        function calculateTradeResult(signal, beStrategy, rTarget) {
            const mfe = beStrategy === 'be1' ? signal.mfe1 : signal.mfeNone;
            if (!mfe || mfe === 0) return rTarget;
            
            if (beStrategy === 'none') {
                return mfe < 0 ? -1 : (mfe >= rTarget ? rTarget : -1);
            } else {
                if (mfe < 1) return -1;
                if (mfe >= 1 && mfe < rTarget) return 0;
                if (mfe >= rTarget) return rTarget;
            }
            return -1;
        }
        
        function calculateStats(results) {
            const wins = results.filter(r => r > 0).length;
            const losses = results.filter(r => r < 0).length;
            const breakevens = results.filter(r => r === 0).length;
            const total = results.length;
            
            const winRate = total > 0 ? ((wins + breakevens) / total) * 100 : 0;
            const totalR = results.reduce((sum, r) => sum + r, 0);
            
            const winResults = results.filter(r => r > 0);
            const lossResults = results.filter(r => r < 0);
            const avgWin = winResults.length > 0 ? winResults.reduce((a, b) => a + b, 0) / winResults.length : 0;
            const avgLoss = lossResults.length > 0 ? Math.abs(lossResults.reduce((a, b) => a + b, 0) / lossResults.length) : 0;
            const expectancy = total > 0 ? (((wins + breakevens) / total) * avgWin) - ((losses / total) * avgLoss) : 0;
            
            let maxConsecLosses = 0, currentConsecLosses = 0;
            let maxDrawdown = 0, currentDrawdown = 0, peak = 0, runningTotal = 0;
            
            results.forEach(result => {
                runningTotal += result;
                if (runningTotal > peak) {
                    peak = runningTotal;
                    currentDrawdown = 0;
                } else {
                    currentDrawdown = peak - runningTotal;
                    maxDrawdown = Math.max(maxDrawdown, currentDrawdown);
                }
                
                if (result < 0) {
                    currentConsecLosses++;
                    maxConsecLosses = Math.max(maxConsecLosses, currentConsecLosses);
                } else if (result > 0) {
                    currentConsecLosses = 0;
                }
            });
            
            return { expectancy, winRate, totalR, maxConsecLosses, maxDrawdown, total };
        }
        
        function calculateScore(stats, constraints) {
            const riskPerTrade = constraints.riskPerTrade;
            const maxDrawdownPercent = stats.maxDrawdown * riskPerTrade;
            const maxConsecLossPercent = stats.maxConsecLosses * riskPerTrade;
            
            const propViable = maxDrawdownPercent <= constraints.maxDrawdown && 
                              stats.maxConsecLosses <= constraints.maxConsecLosses &&
                              stats.winRate >= constraints.minWinRate;
            
            if (!propViable) return -999;
            
            const expectancyScore = stats.expectancy * 30;
            const winRateScore = (stats.winRate / 100) * 20;
            const totalRScore = (stats.totalR / stats.total) * 25;
            const propScore = propViable ? 15 : 0;
            const psychScore = (1 - (stats.maxConsecLosses / 10)) * 10;
            
            return expectancyScore + winRateScore + totalRScore + propScore + psychScore;
        }
        
        async function runOptimization() {
            if (signals.length === 0) {
                await loadSignals();
                if (signals.length === 0) return;
            }
            
            document.getElementById('results').innerHTML = '<div class="loading">üîÑ Analyzing all strategy combinations...</div>';
            
            const constraints = {
                maxConsecLosses: parseInt(document.getElementById('maxConsecLosses').value),
                maxDrawdown: parseFloat(document.getElementById('maxDrawdown').value),
                riskPerTrade: parseFloat(document.getElementById('riskPerTrade').value),
                minWinRate: parseFloat(document.getElementById('minWinRate').value)
            };
            
            const selectedSessions = getSelectedSessions();
            const beStrategies = ['none', 'be1'];
            const rTargets = [1, 1.5, 2, 2.5, 3, 3.5, 4];
            
            let allCombinations = [];
            let bestOverall = null;
            let bestScore = -999;
            
            // Test all combinations
            beStrategies.forEach(beStrategy => {
                rTargets.forEach(rTarget => {
                    // Test individual sessions
                    selectedSessions.forEach(session => {
                        const sessionSignals = signals.filter(s => s.session === session);
                        if (sessionSignals.length < 10) return;
                        
                        const results = sessionSignals.map(s => calculateTradeResult(s, beStrategy, rTarget));
                        const stats = calculateStats(results);
                        const score = calculateScore(stats, constraints);
                        
                        const combo = {
                            sessions: [session],
                            beStrategy,
                            rTarget,
                            stats,
                            score,
                            type: 'single'
                        };
                        
                        allCombinations.push(combo);
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestOverall = combo;
                        }
                    });
                    
                    // Test multi-session combinations
                    if (selectedSessions.length > 1) {
                        const multiSignals = signals.filter(s => selectedSessions.includes(s.session));
                        if (multiSignals.length >= 20) {
                            const results = multiSignals.map(s => calculateTradeResult(s, beStrategy, rTarget));
                            const stats = calculateStats(results);
                            const score = calculateScore(stats, constraints);
                            
                            const combo = {
                                sessions: selectedSessions,
                                beStrategy,
                                rTarget,
                                stats,
                                score,
                                type: 'multi'
                            };
                            
                            allCombinations.push(combo);
                            
                            if (score > bestScore) {
                                bestScore = score;
                                bestOverall = combo;
                            }
                        }
                    }
                });
            });
            
            allCombinations.sort((a, b) => b.score - a.score);
            displayResults(bestOverall, allCombinations.slice(0, 10), constraints);
        }
        
        function displayResults(best, topCombos, constraints) {
            if (!best || best.score === -999) {
                document.getElementById('results').innerHTML = `
                    <div class="warning-box">
                        <strong>‚ùå No viable strategy found</strong><br>
                        All combinations violate prop firm constraints. Try relaxing the limits.
                    </div>
                `;
                return;
            }
            
            const beText = { 'none': 'No Breakeven', 'be1': 'Breakeven at 1R' };
            const sessionsText = best.sessions.length === 1 ? best.sessions[0] : best.sessions.join(' + ');
            
            const maxDrawdownPercent = best.stats.maxDrawdown * constraints.riskPerTrade;
            const totalPercent = best.stats.totalR * constraints.riskPerTrade;
            
            const html = `
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-title">üèÜ OPTIMAL STRATEGY</div>
                        <div class="score-badge">Score: ${best.score.toFixed(1)}</div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Expectancy</div>
                            <div class="metric-value">${best.stats.expectancy.toFixed(3)}R</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Win Rate</div>
                            <div class="metric-value">${best.stats.winRate.toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Return</div>
                            <div class="metric-value">${totalPercent > 0 ? '+' : ''}${totalPercent.toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Max Drawdown</div>
                            <div class="metric-value">${maxDrawdownPercent.toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Max Losses</div>
                            <div class="metric-value">${best.stats.maxConsecLosses}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Trades</div>
                            <div class="metric-value">${best.stats.total}</div>
                        </div>
                    </div>
                    
                    <div class="strategy-details">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">Strategy Configuration</h4>
                        <div class="detail-row">
                            <span class="detail-label">Sessions</span>
                            <span class="detail-value">${sessionsText}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Breakeven Strategy</span>
                            <span class="detail-value">${beText[best.beStrategy]}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">R-Target</span>
                            <span class="detail-value">${best.rTarget}R</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Risk Per Trade</span>
                            <span class="detail-value">${constraints.riskPerTrade}%</span>
                        </div>
                    </div>
                    
                    <div class="success-box">
                        <strong>‚úÖ Prop Firm Compliant</strong><br>
                        This strategy meets all prop firm constraints and is psychologically sustainable.
                    </div>
                </div>
                
                <div class="result-card">
                    <h3 style="color: #00ff88; margin-bottom: 20px;">üìä Top 10 Alternative Strategies</h3>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Sessions</th>
                                <th>BE Strategy</th>
                                <th>R-Target</th>
                                <th>Expectancy</th>
                                <th>Win Rate</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topCombos.map((combo, idx) => {
                                const sessText = combo.sessions.length === 1 ? combo.sessions[0] : `${combo.sessions.length} sessions`;
                                return `
                                    <tr>
                                        <td>${idx + 1}</td>
                                        <td>${sessText}</td>
                                        <td>${beText[combo.beStrategy]}</td>
                                        <td>${combo.rTarget}R</td>
                                        <td>${combo.stats.expectancy.toFixed(3)}R</td>
                                        <td>${combo.stats.winRate.toFixed(1)}%</td>
                                        <td style="color: #00ff88; font-weight: 600;">${combo.score.toFixed(1)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results').innerHTML = html;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSignals();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Analysis - Trading Analytics</title>
    <link rel="stylesheet" href="/style_preload.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
        }
        
        .container { max-width: 1800px; margin: 0 auto; }
        
        .navbar {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 15px;
            backdrop-filter: blur(20px);
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            padding: 10px 18px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-link:hover { background: rgba(255,255,255,0.15); }
        .nav-link.active { color: #00ff88; background: rgba(0,255,136,0.15); }
        
        .header {
            text-align: center;
            padding: 30px;
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #00ff88, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .analysis-section {
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #00ff88;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .data-table th {
            background: rgba(255,255,255,0.1);
            font-weight: 600;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        
        .btn {
            background: linear-gradient(45deg, #00ff88, #00d4aa);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <nav class="navbar">
        <div style="display: flex; gap: 15px; align-items: center; justify-content: center;">
            <a href="/ml-dashboard" class="nav-link">ü§ñ ML</a>
            <a href="/live-signals-dashboard" class="nav-link">üì∂ Live</a>
            <a href="/signal-lab-dashboard" class="nav-link">üè† Dashboard</a>
            <a href="/signal-analysis-lab" class="nav-link">üß™ Signal Lab</a>
            <a href="/time-analysis" class="nav-link active">‚è∞ Time</a>
            <a href="/strategy-optimizer" class="nav-link">üéØ Optimizer</a>
            <a href="/ai-business-advisor" class="nav-link">üß† AI Advisor</a>
            <a href="/prop-portfolio" class="nav-link">üíº Prop</a>
            <a href="/trade-manager" class="nav-link">üìã Trades</a>
            <a href="/financial-summary" class="nav-link">üí∞ Finance</a>
            <a href="/reporting-hub" class="nav-link">üìä Reports</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="header">
            <h1>‚è∞ Time-Based Performance Analysis</h1>
            <p>R-Value Distribution Across Time Windows</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalTrades">0</div>
                <div class="stat-label">Total Trades</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgExpectancy">0.00R</div>
                <div class="stat-label">Avg Expectancy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestHour">--</div>
                <div class="stat-label">Best Hour</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestSession">--</div>
                <div class="stat-label">Best Session</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestDay">--</div>
                <div class="stat-label">Best Day</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestMonth">--</div>
                <div class="stat-label">Best Month</div>
            </div>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">Best Time Windows by Session</div>
            <div id="sessionTimeWindows" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;"></div>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">Hourly Analysis (24-Hour Distribution)</div>
            <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
            </div>
            <table class="data-table" id="hourlyTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">Session Analysis</div>
            <div class="chart-container">
                <canvas id="sessionChart"></canvas>
            </div>
            <table class="data-table" id="sessionTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">4. Day of Week Analysis</div>
            <div class="chart-container">
                <canvas id="dayChart"></canvas>
            </div>
            <table class="data-table" id="dayTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">5. Week of Month Analysis</div>
            <div class="chart-container">
                <canvas id="weekChart"></canvas>
            </div>
            <table class="data-table" id="weekTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">6. Monthly Analysis</div>
            <div class="chart-container">
                <canvas id="monthChart"></canvas>
            </div>
            <table class="data-table" id="monthTable"></table>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="exportTimeAnalysis()">üìä Export Analysis</button>
            <button class="btn" onclick="refreshAnalysis()">üîÑ Refresh</button>
        </div>
    </div>

    <script>
        let timeAnalysisData = null;
        
        async function loadTimeAnalysis() {
            try {
                const response = await fetch('/api/time-analysis');
                if (!response.ok) throw new Error('Failed to load analysis');
                
                timeAnalysisData = await response.json();
                console.log('Time analysis loaded:', timeAnalysisData);
                
                updateStats();
                renderSessionTimeWindows();
                renderHourlyAnalysis();
                renderSessionAnalysis();
                renderDayAnalysis();
                renderWeekAnalysis();
                renderMonthAnalysis();
                
            } catch (error) {
                console.error('Error loading time analysis:', error);
                alert('Failed to load time analysis: ' + error.message);
            }
        }
        
        function updateStats() {
            document.getElementById('totalTrades').textContent = timeAnalysisData.total_trades;
            document.getElementById('avgExpectancy').textContent = parseFloat(timeAnalysisData.overall_expectancy).toFixed(2) + 'R';
            document.getElementById('bestHour').textContent = timeAnalysisData.best_hour.hour;
            document.getElementById('bestSession').textContent = timeAnalysisData.best_session.session;
            document.getElementById('bestDay').textContent = timeAnalysisData.best_day.day;
            document.getElementById('bestMonth').textContent = timeAnalysisData.best_month.month;
        }
        
        function renderSessionTimeWindows() {
            const sessions = {};
            timeAnalysisData.hourly.forEach(h => {
                const hour = h.hour;
                let session = 'Other';
                if (hour >= 0 && hour < 8) session = 'Asia';
                else if (hour >= 8 && hour < 13) session = 'London';
                else if (hour >= 13 && hour < 16) session = 'NY AM';
                else if (hour >= 16 && hour < 20) session = 'NY PM';
                
                if (!sessions[session]) sessions[session] = [];
                sessions[session].push({ hour, expectancy: h.expectancy, trades: h.trades, winRate: h.win_rate });
            });
            
            const container = document.getElementById('sessionTimeWindows');
            container.innerHTML = '';
            
            Object.entries(sessions).forEach(([session, hours]) => {
                hours.sort((a, b) => b.expectancy - a.expectancy);
                const best = hours.slice(0, 3);
                const maxExp = Math.max(...hours.map(h => Math.abs(h.expectancy)));
                
                let html = `<div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px;">`;
                html += `<h3 style="color: #00ff88; margin-bottom: 15px;">${session}</h3>`;
                
                best.forEach(h => {
                    const barWidth = (Math.abs(h.expectancy) / maxExp) * 100;
                    const color = h.expectancy > 0 ? '#00ff88' : '#ff4757';
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
                                <span>${h.hour}:00-${h.hour+1}:00</span>
                                <span style="color: ${color}; font-weight: 600;">${h.expectancy.toFixed(3)}R</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); height: 24px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${barWidth}%; height: 100%; background: ${color}; display: flex; align-items: center; padding: 0 8px; font-size: 11px;">
                                    ${h.trades} trades | ${(h.winRate * 100).toFixed(0)}% WR
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML += html;
            });
        }
        
        function renderHourlyAnalysis() {
            const data = timeAnalysisData.hourly;
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.hour + ':00'),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('hourlyTable', data, ['hour', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderSessionAnalysis() {
            const data = timeAnalysisData.session;
            const ctx = document.getElementById('sessionChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.session),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('sessionTable', data, ['session', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderDayAnalysis() {
            const data = timeAnalysisData.day_of_week;
            const ctx = document.getElementById('dayChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('dayTable', data, ['day', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderWeekAnalysis() {
            const data = timeAnalysisData.week_of_month;
            const ctx = document.getElementById('weekChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => 'Week ' + d.week),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('weekTable', data, ['week', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderMonthAnalysis() {
            const data = timeAnalysisData.monthly;
            const ctx = document.getElementById('monthChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('monthTable', data, ['month', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderTable(tableId, data, columns) {
            const table = document.getElementById(tableId);
            let html = '<thead><tr>';
            
            const headers = {
                window: 'Window',
                hour: 'Hour',
                session: 'Session',
                day: 'Day',
                week: 'Week',
                month: 'Month',
                trades: 'Trades',
                expectancy: 'Expectancy',
                win_rate: 'Win Rate',
                avg_r: 'Avg R',
                std_dev: 'Std Dev'
            };
            
            columns.forEach(col => html += `<th>${headers[col]}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    let className = '';
                    
                    if (col === 'expectancy' || col === 'avg_r') {
                        value = parseFloat(value);
                        className = value > 0 ? 'positive' : value < 0 ? 'negative' : '';
                        value = value.toFixed(3) + 'R';
                    } else if (col === 'win_rate') {
                        value = (parseFloat(value) * 100).toFixed(1) + '%';
                    } else if (col === 'std_dev') {
                        value = parseFloat(value).toFixed(3);
                    }
                    
                    html += `<td class="${className}">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function exportTimeAnalysis() {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `time_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function generateCSV() {
            let csv = 'Time Analysis Export\n\n';
            
            csv += 'Hourly Analysis\n';
            csv += 'Hour,Trades,Expectancy,Win Rate,Avg R,Std Dev\n';
            timeAnalysisData.hourly.forEach(d => {
                csv += `${d.hour},${d.trades},${d.expectancy.toFixed(3)},${(d.win_rate*100).toFixed(1)}%,${d.avg_r.toFixed(3)},${d.std_dev.toFixed(3)}\n`;
            });
            
            csv += '\nSession Analysis\n';
            csv += 'Session,Trades,Expectancy,Win Rate,Avg R,Std Dev\n';
            timeAnalysisData.session.forEach(d => {
                csv += `${d.session},${d.trades},${d.expectancy.toFixed(3)},${(d.win_rate*100).toFixed(1)}%,${d.avg_r.toFixed(3)},${d.std_dev.toFixed(3)}\n`;
            });
            
            return csv;
        }
        
        function refreshAnalysis() {
            loadTimeAnalysis();
        }
        
        document.addEventListener('DOMContentLoaded', loadTimeAnalysis);
    </script>
</body>
</html>

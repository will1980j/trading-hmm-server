<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Analysis - Trading Analytics</title>
    <link rel="stylesheet" href="/style_preload.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        
    
        
    
        
    
        /* Navigation */
        .nav-container {
            background: #141b3d;
            padding: 12px 20px;
            border-bottom: 1px solid #2d3a5f;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            overflow-x: auto;
        }

        .nav-link {
            padding: 8px 12px;
            background: #1a2142;
            color: #f8fafc;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: #3b82f6;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
        <!-- Navigation -->
    <nav class="nav-container">
        <a href="/homepage" class="nav-link">üè† Home</a>
        <a href="/ml-dashboard" class="nav-link">ü§ñ ML</a>
        <a href="/signal-lab-dashboard" class="nav-link">üìä Dashboard</a>
        <a href="/signal-analysis-lab" class="nav-link">üß™ Signal Lab</a>
        <a href="/automated-signals" class="nav-link">üì° Automated Signals</a>
        <a href="/time-analysis" class="nav-link">‚è∞ Time</a>
        <a href="/strategy-optimizer" class="nav-link">üéØ Optimizer</a>
        <a href="/strategy-comparison" class="nav-link">üèÜ Compare</a>
        <a href="/ai-business-advisor" class="nav-link">üß† AI Advisor</a>
        <a href="/prop-portfolio" class="nav-link">üíº Prop</a>
        <a href="/trade-manager" class="nav-link">üìã Trades</a>
        <a href="/financial-summary" class="nav-link">üí∞ Finance</a>
        <a href="/reporting-hub" class="nav-link">üìä Reports</a>
    </nav>

<script>
    (function() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('nav a[data-page]');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.style.background = '#3b82f6';
                link.style.color = 'white';
            }
        });
    })();
    </script>
    
    <div class="container">
        
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalTrades">0</div>
                <div class="stat-label">Total Trades</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgExpectancy">0.00R</div>
                <div class="stat-label">Avg Expectancy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestHour">--</div>
                <div class="stat-label">Best Hour</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestSession">--</div>
                <div class="stat-label">Best Session</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestDay">--</div>
                <div class="stat-label">Best Day</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestMonth">--</div>
                <div class="stat-label">Best Month</div>
            </div>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">Best Time Windows by Session</div>
            <div id="sessionTimeWindows" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;"></div>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">Hourly Analysis (24-Hour Distribution)</div>
            <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
            </div>
            <table class="data-table" id="hourlyTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">Session Analysis</div>
            <div class="chart-container">
                <canvas id="sessionChart"></canvas>
            </div>
            <table class="data-table" id="sessionTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">4. Day of Week Analysis</div>
            <div class="chart-container">
                <canvas id="dayChart"></canvas>
            </div>
            <table class="data-table" id="dayTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">5. Week of Month Analysis</div>
            <div class="chart-container">
                <canvas id="weekChart"></canvas>
            </div>
            <table class="data-table" id="weekTable"></table>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">6. Monthly Analysis</div>
            <div class="chart-container">
                <canvas id="monthChart"></canvas>
            </div>
            <table class="data-table" id="monthTable"></table>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="exportTimeAnalysis()">üìä Export Analysis</button>
            <button class="btn" onclick="refreshAnalysis()">üîÑ Refresh</button>
        </div>
    </div>

    <script>
        let timeAnalysisData = null;
        
        function isDST(date) {
            const year = date.getFullYear();
            const marchSecondSunday = new Date(year, 2, 1);
            marchSecondSunday.setDate(1 + (7 - marchSecondSunday.getDay() + 7) % 7 + 7);
            const novFirstSunday = new Date(year, 10, 1);
            novFirstSunday.setDate(1 + (7 - novFirstSunday.getDay()) % 7);
            return date >= marchSecondSunday && date < novFirstSunday;
        }
        
        function getSessionTimes() {
            const now = new Date();
            const dst = isDST(now);
            const offset = dst ? 0 : 1;
            return {
                'Asia': { start: 20, end: 23 },
                'London': { start: 0, end: 5 },
                'NY Pre Market': { start: 6, end: 8, note: '06:00-08:29' },
                'NY AM': { start: 8, end: 11, note: '08:30-11:59' },
                'NY Lunch': { start: 12, end: 12, note: '12:00-12:59' },
                'NY PM': { start: 13, end: 15, note: '13:00-15:59' }
            };
        }
        
        function displaySessionTimes() {
            const now = new Date();
            const dst = isDST(now);
            const times = getSessionTimes();
            const container = document.getElementById('sessionTimes');
            
            let html = `<strong>Official NASDAQ Session Times (EST/EDT):</strong><br><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">`;
            
            const sessionTimes = {
                'Asia': '20:00-23:59',
                'London': '00:00-05:59', 
                'NY Pre Market': '06:00-08:29',
                'NY AM': '08:30-11:59',
                'NY Lunch': '12:00-12:59',
                'NY PM': '13:00-15:59'
            };
            
            Object.entries(sessionTimes).forEach(([session, timeRange]) => {
                html += `<div style="background: rgba(0,255,136,0.1); padding: 8px; border-radius: 6px;"><strong>${session}:</strong> ${timeRange}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function loadTimeAnalysis() {
            try {
                const response = await fetch('/api/time-analysis');
                if (!response.ok) throw new Error('Failed to load analysis');
                
                timeAnalysisData = await response.json();
                console.log('Time analysis loaded:', timeAnalysisData);
                
                displaySessionTimes();
                updateStats();
                renderSessionTimeWindows();
                renderHourlyAnalysis();
                renderSessionAnalysis();
                renderDayAnalysis();
                renderWeekAnalysis();
                renderMonthAnalysis();
                
            } catch (error) {
                console.error('Error loading time analysis:', error);
                alert('Failed to load time analysis: ' + error.message);
            }
        }
        
        function updateStats() {
            document.getElementById('totalTrades').textContent = timeAnalysisData.total_trades;
            document.getElementById('avgExpectancy').textContent = parseFloat(timeAnalysisData.overall_expectancy).toFixed(2) + 'R';
            document.getElementById('bestHour').textContent = timeAnalysisData.best_hour.hour;
            document.getElementById('bestSession').textContent = timeAnalysisData.best_session.session;
            document.getElementById('bestDay').textContent = timeAnalysisData.best_day.day;
            document.getElementById('bestMonth').textContent = timeAnalysisData.best_month.month;
        }
        
        function renderSessionTimeWindows() {
            const container = document.getElementById('sessionTimeWindows');
            container.innerHTML = '';
            
            const sessionMap = {
                'Asia': { hours: [20, 21, 22, 23] },
                'London': { hours: [0, 1, 2, 3, 4, 5] },
                'NY Pre Market': { hours: [6, 7] },
                'NY AM': { hours: [8, 9, 10, 11] },
                'NY Lunch': { hours: [12] },
                'NY PM': { hours: [13, 14, 15] }
            };
            
            Object.entries(sessionMap).forEach(([session, config]) => {
                const hours = timeAnalysisData.hourly.filter(h => config.hours.includes(h.hour));
                if (hours.length === 0) return;
                
                hours.sort((a, b) => b.expectancy - a.expectancy);
                const best = hours.slice(0, 3);
                const maxExp = Math.max(...hours.map(h => Math.abs(h.expectancy)));
                
                let html = `<div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px;">`;
                html += `<h3 style="color: #00ff88; margin-bottom: 15px;">${session}</h3>`;
                
                best.forEach(h => {
                    const barWidth = (Math.abs(h.expectancy) / maxExp) * 100;
                    const color = h.expectancy > 0 ? '#00ff88' : '#ff4757';
                    const winRate = h.win_rate || h.winRate || 0;
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
                                <span>${h.hour}:00-${h.hour+1}:00</span>
                                <span style="color: ${color}; font-weight: 600;">${h.expectancy.toFixed(3)}R</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); height: 24px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${barWidth}%; height: 100%; background: ${color}; display: flex; align-items: center; padding: 0 8px; font-size: 11px; color: #000;">
                                    ${h.trades} trades | ${(winRate * 100).toFixed(0)}% WR
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML += html;
            });
        }
        
        function renderHourlyAnalysis() {
            const data = timeAnalysisData.hourly;
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.hour + ':00'),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('hourlyTable', data, ['hour', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderSessionAnalysis() {
            const data = timeAnalysisData.session;
            const ctx = document.getElementById('sessionChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.session),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('sessionTable', data, ['session', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderDayAnalysis() {
            const data = timeAnalysisData.day_of_week;
            const ctx = document.getElementById('dayChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('dayTable', data, ['day', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderWeekAnalysis() {
            const data = timeAnalysisData.week_of_month;
            const ctx = document.getElementById('weekChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => 'Week ' + d.week),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('weekTable', data, ['week', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderMonthAnalysis() {
            const data = timeAnalysisData.monthly;
            const ctx = document.getElementById('monthChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Expectancy (R)',
                        data: data.map(d => d.expectancy),
                        backgroundColor: data.map(d => d.expectancy > 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 71, 87, 0.6)'),
                        borderColor: data.map(d => d.expectancy > 0 ? '#00ff88' : '#ff4757'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
            
            renderTable('monthTable', data, ['month', 'trades', 'expectancy', 'win_rate', 'avg_r', 'std_dev']);
        }
        
        function renderTable(tableId, data, columns) {
            const table = document.getElementById(tableId);
            let html = '<thead><tr>';
            
            const headers = {
                window: 'Window',
                hour: 'Hour',
                session: 'Session',
                day: 'Day',
                week: 'Week',
                month: 'Month',
                trades: 'Trades',
                expectancy: 'Expectancy',
                win_rate: 'Win Rate',
                avg_r: 'Avg R',
                std_dev: 'Std Dev'
            };
            
            columns.forEach(col => html += `<th>${headers[col]}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    let className = '';
                    
                    if (col === 'expectancy' || col === 'avg_r') {
                        value = parseFloat(value);
                        className = value > 0 ? 'positive' : value < 0 ? 'negative' : '';
                        value = value.toFixed(3) + 'R';
                    } else if (col === 'win_rate') {
                        value = (parseFloat(value) * 100).toFixed(1) + '%';
                    } else if (col === 'std_dev') {
                        value = parseFloat(value).toFixed(3);
                    }
                    
                    html += `<td class="${className}">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function exportTimeAnalysis() {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `time_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function generateCSV() {
            let csv = 'Time Analysis Export\n\n';
            
            csv += 'Hourly Analysis\n';
            csv += 'Hour,Trades,Expectancy,Win Rate,Avg R,Std Dev\n';
            timeAnalysisData.hourly.forEach(d => {
                csv += `${d.hour},${d.trades},${d.expectancy.toFixed(3)},${(d.win_rate*100).toFixed(1)}%,${d.avg_r.toFixed(3)},${d.std_dev.toFixed(3)}\n`;
            });
            
            csv += '\nSession Analysis\n';
            csv += 'Session,Trades,Expectancy,Win Rate,Avg R,Std Dev\n';
            timeAnalysisData.session.forEach(d => {
                csv += `${d.session},${d.trades},${d.expectancy.toFixed(3)},${(d.win_rate*100).toFixed(1)}%,${d.avg_r.toFixed(3)},${d.std_dev.toFixed(3)}\n`;
            });
            
            return csv;
        }
        
        function refreshAnalysis() {
            loadTimeAnalysis();
        }
        
        document.addEventListener('DOMContentLoaded', loadTimeAnalysis);
    </script>
</div><!-- container -->
</body>
</html>


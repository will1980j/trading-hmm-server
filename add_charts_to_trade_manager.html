<!-- Add this section to trade_manager.html after stats-grid -->

<div class="data-input">
    <h3>Performance Charts</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
            <h4>Equity Curve</h4>
            <div id="d3EquityChart" style="height: 250px;"></div>
        </div>
        <div>
            <h4>R-Score Distribution</h4>
            <div id="d3RScoreChart" style="height: 250px;"></div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
            <h4>Session Performance</h4>
            <div id="d3SessionHeatmapChart" style="height: 250px;"></div>
        </div>
        <div>
            <h4>Day of Week</h4>
            <div id="d3DayOfWeekChart" style="height: 250px;"></div>
        </div>
    </div>
</div>

<!-- Add D3.js library -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Add to existing script section -->
<script>
// Add these helper functions
function getFilteredTrades() {
    return trades; // Use existing trades array
}

function getRValue(trade, rTarget = 1) {
    return trade.rScore || 0;
}

function getWeekString(date) {
    const year = date.getFullYear();
    const week = Math.ceil((date.getDate() + new Date(year, 0, 1).getDay()) / 7);
    return `${year}-W${week}`;
}

function analyzeDayOfWeek(trades, rTarget) {
    const days = [0, 0, 0, 0, 0]; // Mon-Fri
    trades.forEach(trade => {
        const day = new Date(trade.date).getDay();
        if (day >= 1 && day <= 5) {
            days[day - 1] += getRValue(trade, rTarget);
        }
    });
    return { expectancy: days };
}

function analyzeSeasonality(trades, rTarget) {
    const months = new Array(12).fill(0);
    trades.forEach(trade => {
        const month = new Date(trade.date).getMonth();
        months[month] += getRValue(trade, rTarget);
    });
    return months;
}

function calculateRollingPerformance(trades, rTarget, window) {
    const values = [];
    for (let i = window; i < trades.length; i++) {
        const windowTrades = trades.slice(i - window, i);
        const sum = windowTrades.reduce((acc, t) => acc + getRValue(t, rTarget), 0);
        values.push(sum);
    }
    return { values };
}

function analyzeSessionPerformance(trades, rTarget) {
    const sessions = { ASIA: 0, LONDON: 0, 'NY PRE MARKET': 0, 'NEW YORK AM': 0, 'NY LUNCH': 0, 'NEW YORK PM': 0 };
    trades.forEach(trade => {
        if (sessions.hasOwnProperty(trade.session)) {
            sessions[trade.session] += getRValue(trade, rTarget);
        }
    });
    return Object.values(sessions);
}

// Update the existing updateDisplay function
const originalUpdateDisplay = updateDisplay;
updateDisplay = function() {
    originalUpdateDisplay();
    
    // Initialize and update D3 charts
    if (typeof d3 !== 'undefined' && trades.length > 0) {
        if (!window.d3Charts) {
            initD3Charts();
        }
        updateD3Charts();
    }
};
</script>
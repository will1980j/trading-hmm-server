<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Drift Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0e27; color: #f8fafc; padding: 20px; }
        .header { margin-bottom: 30px; }
        h1 { font-size: 28px; background: linear-gradient(135deg, #3b82f6, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .health-score { display: flex; align-items: center; gap: 20px; background: #1a2142; padding: 30px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #2d3a5f; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; position: relative; }
        .score-circle.healthy { background: linear-gradient(135deg, #10b981, #059669); }
        .score-circle.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .score-circle.critical { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .health-info h2 { font-size: 24px; margin-bottom: 8px; }
        .health-status { font-size: 14px; color: #94a3b8; }
        .alerts-container { background: #1a2142; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #2d3a5f; }
        .alert-item { padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid; }
        .alert-item.critical { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }
        .alert-item.high { background: rgba(245, 158, 11, 0.1); border-color: #f59e0b; }
        .alert-item.medium { background: rgba(59, 130, 246, 0.1); border-color: #3b82f6; }
        .alert-item.low { background: rgba(16, 185, 129, 0.1); border-color: #10b981; }
        .alert-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .alert-type { font-weight: 600; text-transform: uppercase; font-size: 12px; }
        .alert-time { font-size: 11px; color: #94a3b8; }
        .drift-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .drift-card { background: #1a2142; padding: 20px; border-radius: 12px; border: 1px solid #2d3a5f; }
        .drift-card h3 { font-size: 16px; margin-bottom: 15px; color: #f8fafc; }
        .metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2d3a5f; }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: #94a3b8; font-size: 13px; }
        .metric-value { font-weight: 600; }
        .chart-container { background: #1a2142; padding: 25px; border-radius: 12px; border: 1px solid #2d3a5f; margin-bottom: 20px; }
        .chart-wrapper { position: relative; height: 300px; }
        .loading { text-align: center; padding: 40px; color: #94a3b8; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge.critical { background: #ef4444; color: white; }
        .badge.high { background: #f59e0b; color: white; }
        .badge.medium { background: #3b82f6; color: white; }
        .badge.low { background: #10b981; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Model Drift Detection</h1>
        <p style="color: #94a3b8; font-size: 14px;">Real-time monitoring of ML model health and drift</p>
    </div>

    <div id="loading" class="loading">Loading drift detection data...</div>

    <div id="content" style="display: none;">
        <div class="health-score">
            <div id="scoreCircle" class="score-circle healthy">
                <span id="scoreValue">--</span>
            </div>
            <div class="health-info">
                <h2 id="healthStatus">Model Health</h2>
                <p class="health-status" id="healthRecommendation">Analyzing...</p>
                <p style="font-size: 12px; color: #64748b; margin-top: 8px;" id="lastUpdate">Last updated: --</p>
            </div>
        </div>

        <div class="alerts-container">
            <h3 style="margin-bottom: 15px;">üö® Active Alerts</h3>
            <div id="alertsList"></div>
        </div>

        <div class="drift-grid">
            <div class="drift-card">
                <h3>üìä Feature Drift</h3>
                <div id="featureDriftMetrics"></div>
            </div>
            <div class="drift-card">
                <h3>üìà Performance Drift</h3>
                <div id="performanceDriftMetrics"></div>
            </div>
        </div>

        <div class="chart-container">
            <h3 style="margin-bottom: 20px;">Performance Trend (30 Days)</h3>
            <div class="chart-wrapper">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 style="margin-bottom: 20px;">Feature Drift Heatmap</h3>
            <div class="chart-wrapper">
                <canvas id="driftHeatmap"></canvas>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        async function loadDriftData() {
            try {
                const response = await fetch('/api/model-drift');
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                updateHealthScore(data.health_score, data.status, data.recommendation);
                displayAlerts(data.alerts);
                displayFeatureDrift(data.feature_drift);
                displayPerformanceDrift(data.performance_drift);
                createPerformanceChart(data.performance_history);
                createDriftHeatmap(data.feature_drift);
                
                document.getElementById('lastUpdate').textContent = 
                    'Last updated: ' + new Date(data.timestamp).toLocaleString();
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    '<p style="color: #ef4444;">Error loading drift data: ' + error.message + '</p>';
            }
        }

        function updateHealthScore(score, status, recommendation) {
            const circle = document.getElementById('scoreCircle');
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('healthStatus').textContent = status;
            document.getElementById('healthRecommendation').textContent = recommendation;
            
            circle.className = 'score-circle';
            if (score >= 80) circle.classList.add('healthy');
            else if (score >= 60) circle.classList.add('warning');
            else circle.classList.add('critical');
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alertsList');
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<p style="color: #10b981;">‚úì No active alerts</p>';
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.severity.toLowerCase()}">
                    <div class="alert-header">
                        <span class="alert-type">${alert.type.replace(/_/g, ' ')}</span>
                        <span class="badge ${alert.severity.toLowerCase()}">${alert.severity}</span>
                    </div>
                    <p style="font-size: 14px;">${alert.message}</p>
                </div>
            `).join('');
        }

        function displayFeatureDrift(featureDrift) {
            const container = document.getElementById('featureDriftMetrics');
            if (!featureDrift) {
                container.innerHTML = '<p style="color: #94a3b8;">No drift data</p>';
                return;
            }
            
            let html = '';
            for (const [feature, data] of Object.entries(featureDrift)) {
                html += `
                    <div class="metric">
                        <span class="metric-label">${feature}</span>
                        <span class="metric-value">
                            PSI: ${data.psi.toFixed(3)} 
                            <span class="badge ${data.severity.toLowerCase()}">${data.severity}</span>
                        </span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function displayPerformanceDrift(perfDrift) {
            const container = document.getElementById('performanceDriftMetrics');
            if (!perfDrift || perfDrift.status === 'insufficient_data') {
                container.innerHTML = '<p style="color: #94a3b8;">Insufficient data</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Current Accuracy</span>
                    <span class="metric-value">${(perfDrift.current_accuracy * 100).toFixed(1)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Accuracy</span>
                    <span class="metric-value">${(perfDrift.avg_accuracy * 100).toFixed(1)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Trend</span>
                    <span class="metric-value" style="color: ${perfDrift.trend_slope < 0 ? '#ef4444' : '#10b981'}">
                        ${perfDrift.trend_slope > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(perfDrift.trend_slope * 100).toFixed(2)}%
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="badge ${perfDrift.severity.toLowerCase()}">${perfDrift.severity}</span>
                </div>
            `;
        }

        function createPerformanceChart(history) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (charts.performance) charts.performance.destroy();
            
            const mockData = Array.from({length: 30}, (_, i) => ({
                date: new Date(Date.now() - (29 - i) * 24 * 60 * 60 * 1000).toLocaleDateString(),
                accuracy: 0.65 + Math.random() * 0.15 - (i * 0.002)
            }));
            
            charts.performance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: mockData.map(d => d.date),
                    datasets: [{
                        label: 'Model Accuracy',
                        data: mockData.map(d => d.accuracy * 100),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#f8fafc' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: '#2d3a5f' } },
                        y: { 
                            ticks: { color: '#94a3b8' }, 
                            grid: { color: '#2d3a5f' },
                            min: 50,
                            max: 100
                        }
                    }
                }
            });
        }

        function createDriftHeatmap(featureDrift) {
            const ctx = document.getElementById('driftHeatmap').getContext('2d');
            if (charts.heatmap) charts.heatmap.destroy();
            
            if (!featureDrift) return;
            
            const features = Object.keys(featureDrift);
            const psiValues = features.map(f => featureDrift[f].psi);
            
            charts.heatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: features,
                    datasets: [{
                        label: 'PSI Score',
                        data: psiValues,
                        backgroundColor: psiValues.map(v => 
                            v > 0.25 ? '#ef4444' : v > 0.2 ? '#f59e0b' : v > 0.1 ? '#3b82f6' : '#10b981'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#f8fafc' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: '#2d3a5f' } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: '#2d3a5f' } }
                    }
                }
            });
        }

        loadDriftData();
        setInterval(loadDriftData, 300000); // Refresh every 5 minutes
    </script>
</body>
</html>

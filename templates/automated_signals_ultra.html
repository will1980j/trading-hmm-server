{% extends 'layout.html' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/platform.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/automated_signals_ultra.css') }}">
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endblock %}

{% block content %}
    <div class="container-fluid mt-4 px-4">
        <!-- PAGE HEADER -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h1 class="h3 mb-1 ultra-title">Automated Signals Engine</h1>
                        <p class="ultra-muted mb-0">H1.1 &mdash; Core lifecycle dashboard for all signals and trades</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-end">
                            <div class="small ultra-muted ultra-metric-label">Last Webhook</div>
                            <div id="ase-last-webhook" class="fw-semibold ultra-metric-value">--:--:--</div>
                        </div>
                        <div class="text-end">
                            <div class="small ultra-muted ultra-metric-label">Signals Today</div>
                            <div id="ase-signals-today" class="fw-semibold ultra-metric-value">0</div>
                        </div>
                        <div class="text-end">
                            <div class="small ultra-muted ultra-metric-label">Active Trades</div>
                            <div id="ase-active-count" class="fw-semibold ultra-metric-value">0</div>
                        </div>
                        <div>
                            <span id="ase-health-pill" class="badge rounded-pill bg-secondary">Engine Status: Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOP TABS -->
        <div class="row mb-3">
            <div class="col-12">
                <ul class="nav nav-tabs" id="automatedSignalsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-active active" id="live-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-live" type="button" role="tab" 
                                aria-controls="tab-live" aria-selected="true">‚ö° Live Signals</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-inactive" id="cancelled-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-cancelled" type="button" role="tab" 
                                aria-controls="tab-cancelled" aria-selected="false">‚ùå Cancelled Signals</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-inactive" id="analytics-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-analytics" type="button" role="tab" 
                                aria-controls="tab-analytics" aria-selected="false">üìä Signal Analytics</button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="automatedSignalsTabContent">
            <!-- TAB 1: LIVE SIGNALS -->
            <div class="tab-pane fade show active" id="tab-live" role="tabpanel" aria-labelledby="live-tab">
                <div class="row">
                    <!-- LEFT COLUMN: TABLES + CALENDAR -->
                    <div class="col-lg-7 mb-4">
                        <!-- TRADING CALENDAR -->
                        <div class="dashboard-card ultra-card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center py-2">
                                <h3 class="card-title mb-0 ultra-section-header" style="font-size: 0.95rem;">Trading Calendar</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm ultra-btn-compact" id="ase-calendar-prev">&laquo;</button>
                                    <span id="ase-calendar-month" class="small fw-semibold ultra-text" style="min-width: 100px; text-align: center;">Loading...</span>
                                    <button class="btn btn-sm ultra-btn-compact" id="ase-calendar-next">&raquo;</button>
                                </div>
                            </div>
                            <div class="card-body py-2 px-3">
                                <div id="ase-calendar-container">
                                    <div class="text-muted small">Loading calendar...</div>
                                </div>
                                <div class="d-flex justify-content-center gap-3 mt-2" style="font-size: 10px;">
                                    <span><span class="calendar-legend-dot" style="background: #3b82f6;"></span> Completed</span>
                                    <span><span class="calendar-legend-dot" style="background: #00ff88;"></span> Active</span>
                                    <span id="ase-selected-date-label" class="ultra-muted" style="margin-left: 8px;">Click a day to filter</span>
                                </div>
                            </div>
                        </div>

                        <!-- FILTERS ROW -->
                        <div class="dashboard-card ultra-card mb-3">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex flex-wrap align-items-center gap-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="ultra-filter-label-sm">Session:</span>
                                        <div class="btn-group btn-group-sm" role="group" id="ase-session-filter">
                                            <button type="button" class="btn ultra-btn-sm active" data-session="ALL">All</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="ASIA">Asia</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="LONDON">Lon</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="NY AM">NY AM</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="NY PM">NY PM</button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="ultra-filter-label-sm">Dir:</span>
                                        <div class="btn-group btn-group-sm" role="group" id="ase-direction-filter">
                                            <button type="button" class="btn ultra-btn-sm active" data-direction="ALL">All</button>
                                            <button type="button" class="btn ultra-btn-sm" data-direction="Bullish">Bull</button>
                                            <button type="button" class="btn ultra-btn-sm" data-direction="Bearish">Bear</button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="ultra-filter-label-sm">State:</span>
                                        <div class="btn-group btn-group-sm" role="group" id="ase-state-filter">
                                            <button type="button" class="btn ultra-btn-sm active" data-state="ALL">All</button>
                                            <button type="button" class="btn ultra-btn-sm" data-state="ACTIVE">Active</button>
                                            <button type="button" class="btn ultra-btn-sm" data-state="COMPLETED">Done</button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 ms-auto">
                                        <input type="text" class="form-control form-control-sm ultra-input-sm" id="ase-search-trade-id" 
                                               placeholder="Search ID..." style="width: 120px;">
                                        <button class="btn ultra-btn-sm" id="ase-clear-filters" title="Clear all filters">‚úï</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LIVE SIGNALS TABLE (Pending + Active + Completed) -->
                        <div class="dashboard-card ultra-card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <h3 class="card-title mb-0 ultra-section-header" style="font-size: 0.95rem;">Signals & Trades</h3>
                                    <span id="ase-table-date" class="ultra-muted small"></span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn ultra-btn-danger" id="ase-delete-selected" disabled title="Delete selected trades">üóë Delete</button>
                                    <span class="badge rounded-pill bg-secondary small ultra-text" id="ase-table-count">0 rows</span>
                                    <button class="btn btn-sm btn-outline-light ultra-btn" id="ase-refresh-btn">Refresh</button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
                                    <table class="ultra-table" id="ase-signals-table" style="font-size: 11px;">
                                        <thead class="position-sticky top-0" style="background: rgba(25,30,60,0.95);">
                                            <tr>
                                                <th style="width: 30px;"><input type="checkbox" class="trade-checkbox" id="ase-select-all" title="Select all"></th>
                                                <th>Status</th>
                                                <th>Time</th>
                                                <th>Dir</th>
                                                <th>Session</th>
                                                <th>Entry</th>
                                                <th>Stop</th>
                                                <th title="MFE with Break-Even at 1R">MFE BE=1</th>
                                                <th title="MFE without Break-Even">MFE No BE</th>
                                                <th>Age</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ase-signals-tbody">
                                            <tr>
                                                <td colspan="10" class="text-center ultra-muted py-3">Loading signals...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: DETAILS + SUMMARY -->
                    <div class="col-lg-5 mb-4">
                        <!-- TRADE DETAIL / LIFECYCLE PANEL -->
                        <div class="dashboard-card ultra-card ultra-panel mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title mb-0 ultra-section-header">Trade Lifecycle</h3>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge rounded-pill bg-secondary small ultra-text" id="ase-detail-status">No trade selected</span>
                                    <button type="button" class="btn btn-sm btn-outline-light ultra-btn" id="ase-lifecycle-expand" disabled>Expand</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="ase-trade-detail-placeholder" class="ultra-muted small">
                                    Select a signal from the table to view its full lifecycle journey (Entry ‚Üí BE ‚Üí MFE ‚Üí Exit).
                                </div>
                                <div id="ase-trade-detail-container" style="display: none;">
                                    <!-- JS will render the graphical lifecycle here -->
                                </div>
                            </div>
                        </div>

                        <!-- STATS SUMMARY PANEL -->
                        <div class="dashboard-card ultra-card mb-4">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">Signal & Trade Summary</h3>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Signals Today</div>
                                        <div id="ase-summary-signals-today" class="fw-semibold ultra-metric-value">0</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Confirmed Today</div>
                                        <div id="ase-summary-confirmed" class="fw-semibold ultra-metric-value">0</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Win Rate (Today)</div>
                                        <div id="ase-summary-winrate" class="fw-semibold ultra-badge-green">--%</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Avg MFE (No BE)</div>
                                        <div id="ase-summary-avgmfe" class="fw-semibold ultra-badge-green">0.00R</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">BE Triggers</div>
                                        <div id="ase-summary-be-count" class="fw-semibold ultra-badge-amber">0</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">SL Events</div>
                                        <div id="ase-summary-sl-count" class="fw-semibold ultra-badge-red">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FUTURE ANALYTICS (ROADMAP LOCKED) -->
                        <div class="dashboard-card ultra-card">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">Future Analytics (Roadmap Locked)</h3>
                            </div>
                            <div class="card-body">
                                <div class="ultra-muted small mb-2">Advanced analytics will unlock here as H2/H3 modules are completed.</div>
                                <ul class="small mb-0 ultra-locked">
                                    <li><span class="ultra-lock-icon">üîí</span> Execution Quality Engine (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> Signal Outcome Predictor (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> Regime Classifier (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> MFE Distribution Engine (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> BE Efficiency Analytics (locked)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: CANCELLED SIGNALS -->
            <div class="tab-pane fade" id="tab-cancelled" role="tabpanel" aria-labelledby="cancelled-tab">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="dashboard-card ultra-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title mb-0 ultra-section-header">Cancelled Signals</h3>
                                <span class="badge rounded-pill bg-secondary small ultra-text" id="ase-cancelled-count">0</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
                                    <table class="table table-sm table-dark mb-0 ultra-table" id="ase-cancelled-table">
                                        <thead class="position-sticky top-0">
                                            <tr>
                                                <th scope="col">Time</th>
                                                <th scope="col">Dir</th>
                                                <th scope="col">Session</th>
                                                <th scope="col">Reason</th>
                                                <th scope="col">Age Before Cancel</th>
                                                <th scope="col">ID</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ase-cancelled-tbody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted small py-3">No cancelled signals loaded yet.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: SIGNAL ANALYTICS -->
            <div class="tab-pane fade" id="tab-analytics" role="tabpanel" aria-labelledby="analytics-tab">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="dashboard-card ultra-card">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">Signal Efficiency</h3>
                            </div>
                            <div class="card-body">
                                <div id="ase-signal-efficiency-container" class="ultra-muted small">
                                    Analytics will appear here once the stats integration is wired.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="dashboard-card ultra-card">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">Session Performance</h3>
                            </div>
                            <div class="card-body">
                                <div id="ase-session-performance-container" class="ultra-muted small">
                                    Session-wise signal and trade performance will be rendered here.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="dashboard-card ultra-card">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">R-Multiple Distribution</h3>
                            </div>
                            <div class="card-body">
                                <div id="ase-rdist-container" class="ultra-muted small">
                                    Future chart panel for R-multiple distributions.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="dashboard-card ultra-card">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">Roadmap-Locked Intelligence</h3>
                            </div>
                            <div class="card-body">
                                <div class="ultra-muted small mb-2">These analytics will unlock when the corresponding H2/H3 modules are completed in the roadmap.</div>
                                <ul class="small mb-0 ultra-locked">
                                    <li><span class="ultra-lock-icon">üîí</span> Regime Classifier</li>
                                    <li><span class="ultra-lock-icon">üîí</span> Entry Confidence Model</li>
                                    <li><span class="ultra-lock-icon">üîí</span> ML-Enhanced Signal Validation</li>
                                    <li><span class="ultra-lock-icon">üîí</span> Execution Quality Benchmarks</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.tab-content -->
    </div>
    <!-- /.container-fluid -->

    <!-- Full-Screen Lifecycle Overlay -->
    <div id="ase-lifecycle-overlay" style="display:none; position:fixed; inset:0; background:rgba(4,10,20,0.95); z-index:1050; overflow-y:auto;">
        <div style="max-width: 1200px; margin: 30px auto; background: linear-gradient(135deg, #0a1628, #0d2240); border-radius: 16px; padding: 28px; box-shadow: 0 0 60px rgba(0,100,255,0.15); border: 1px solid rgba(59,130,246,0.25);">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 mb-1" id="ase-lifecycle-title" style="color:#e2e8f0;">Trade Journey</h2>
                    <p class="small mb-0" id="ase-lifecycle-subtitle" style="color:rgba(226,232,240,0.7);">Select a trade from the table to see its full lifecycle.</p>
                </div>
                <button type="button" class="btn btn-sm" id="ase-lifecycle-close" style="background:rgba(255,255,255,0.1); color:#e2e8f0; border:1px solid rgba(255,255,255,0.2);">‚úï Close</button>
            </div>
            
            <!-- Main R-Chart Area -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color:#3b82f6; font-weight:600; font-size:14px;">üìà MFE Journey (R-Multiple vs Time)</span>
                    <span id="ase-chart-live-indicator" style="color:#22c55e; font-size:12px;">‚óè Live</span>
                </div>
                <div id="ase-lifecycle-chart" style="background: rgba(8,16,32,0.95); border-radius: 12px; border: 1px solid rgba(59,130,246,0.2); min-height: 320px; position:relative;">
                    <!-- D3.js chart rendered here -->
                    <svg id="ase-lifecycle-svg" width="100%" height="320"></svg>
                </div>
            </div>
            
            <!-- Bottom Row: Events + Metrics -->
            <div class="row g-4">
                <div class="col-md-7">
                    <div style="color:#3b82f6; font-weight:600; font-size:14px; margin-bottom:8px;">üìã Event Stream</div>
                    <div id="ase-lifecycle-events" style="background: rgba(8,16,32,0.9); border-radius: 10px; border: 1px solid rgba(59,130,246,0.15); max-height: 180px; overflow-y: auto; padding: 12px;">
                        <div style="color:rgba(226,232,240,0.5); font-size:13px;">No events loaded.</div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div style="color:#3b82f6; font-weight:600; font-size:14px; margin-bottom:8px;">üìä Trade Metrics</div>
                    <div id="ase-lifecycle-metrics" style="background: rgba(8,16,32,0.9); border-radius: 10px; border: 1px solid rgba(59,130,246,0.15); padding: 14px;">
                        <div style="color:rgba(226,232,240,0.5); font-size:13px;">No trade selected.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/automated_signals_ultra.js') }}?v={{ range(100000, 999999) | random }}"></script>
{% endblock %}

{% extends 'layout.html' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/platform.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/automated_signals_ultra.css') }}">
<style>
.diagnosis-pre {
    background:#111827;
    padding:10px;
    border-radius:6px;
    color:#e5e7eb;
    max-height:260px;
    overflow-y:auto;
    white-space:pre-wrap;
    font-size:12px;
    border:1px solid #374151;
}
.copy-btn {
    background:#1f2937;
    padding:6px 12px;
    margin-top:5px;
    border-radius:4px;
    color:#e5e7eb;
    cursor:pointer;
    font-size:12px;
    border:1px solid #4b5563;
}
.copy-btn:hover { background:#111827; }
.diagnosis-header {
    cursor:pointer;
    margin-top:15px;
    background:#111827;
    padding:8px;
    border-radius:6px;
    border:1px solid #374151;
    color:#e5e7eb;
    font-size:14px;
}
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endblock %}

{% block content %}
    <div class="container-fluid mt-4 px-4">
        <!-- PAGE HEADER -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h1 class="h3 mb-1 ultra-title">Automated Signals Engine</h1>
                        <p class="ultra-muted mb-0">H1.1 &mdash; Core lifecycle dashboard for all signals and trades</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-end">
                            <div class="small ultra-muted ultra-metric-label">Last Webhook</div>
                            <div id="ase-last-webhook" class="fw-semibold ultra-metric-value">--:--:--</div>
                        </div>
                        <div class="text-end">
                            <div class="small ultra-muted ultra-metric-label">Signals Today</div>
                            <div id="ase-signals-today" class="fw-semibold ultra-metric-value">0</div>
                        </div>
                        <div class="text-end">
                            <div class="small ultra-muted ultra-metric-label">Active Signals</div>
                            <div id="ase-active-count" class="fw-semibold ultra-metric-value">0</div>
                        </div>
                        <div>
                            <span id="ase-health-pill" class="badge rounded-pill bg-secondary">Engine Status: Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOP TABS -->
        <div class="row mb-3">
            <div class="col-12">
                <ul class="nav nav-tabs" id="automatedSignalsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-active active" id="all-signals-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-all-signals" type="button" role="tab" 
                                aria-controls="tab-all-signals" aria-selected="true">üìç All Signals</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-inactive" id="confirmed-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-confirmed" type="button" role="tab" 
                                aria-controls="tab-confirmed" aria-selected="false">‚úÖ Confirmed Signals</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-inactive" id="cancelled-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-cancelled" type="button" role="tab" 
                                aria-controls="tab-cancelled" aria-selected="false">‚ùå Cancelled Signals</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-inactive" id="analytics-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-analytics" type="button" role="tab" 
                                aria-controls="tab-analytics" aria-selected="false">üìä Signal Analytics</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ultra-tab ultra-tab-inactive" id="data-quality-tab" data-bs-toggle="tab" 
                                data-bs-target="#tab-data-quality" type="button" role="tab" 
                                aria-controls="tab-data-quality" aria-selected="false">üîç Data Quality</button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="automatedSignalsTabContent" style="min-height: 600px;">
            <!-- TAB 1: CONFIRMED SIGNALS - Content stays here, just swap IDs -->
            <div class="tab-pane fade" id="tab-confirmed" role="tabpanel" aria-labelledby="confirmed-tab">
                <div class="row">
                    <!-- LEFT COLUMN: TABLES + CALENDAR -->
                    <div class="col-lg-7 mb-4">
                        <!-- TRADING CALENDAR -->
                        <div class="dashboard-card ultra-card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center py-2">
                                <h3 class="card-title mb-0 ultra-section-header" style="font-size: 0.95rem;">Trading Calendar</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm ultra-btn-compact" id="ase-calendar-prev">&laquo;</button>
                                    <span id="ase-calendar-month" class="small fw-semibold ultra-text" style="min-width: 100px; text-align: center;">Loading...</span>
                                    <button class="btn btn-sm ultra-btn-compact" id="ase-calendar-next">&raquo;</button>
                                </div>
                            </div>
                            <div class="card-body py-2 px-3">
                                <div id="ase-calendar-container">
                                    <div class="text-muted small">Loading calendar...</div>
                                </div>
                                <div class="d-flex justify-content-center gap-3 mt-2" style="font-size: 10px;">
                                    <span><span class="calendar-legend-dot" style="background: #94a3b8;"></span> Completed</span>
                                    <span><span class="calendar-legend-dot" style="background: #00ff88;"></span> Active</span>
                                    <span id="ase-selected-date-label" class="ultra-muted" style="margin-left: 8px;">Click a day to filter</span>
                                </div>
                            </div>
                        </div>

                        <!-- FILTERS ROW -->
                        <div class="dashboard-card ultra-card mb-3">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex flex-wrap align-items-center gap-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="ultra-filter-label-sm">Session:</span>
                                        <div class="btn-group btn-group-sm" role="group" id="ase-session-filter">
                                            <button type="button" class="btn ultra-btn-sm active" data-session="ALL">All</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="ASIA">Asia</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="LONDON">Lon</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="NY AM">NY AM</button>
                                            <button type="button" class="btn ultra-btn-sm" data-session="NY PM">NY PM</button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="ultra-filter-label-sm">Dir:</span>
                                        <div class="btn-group btn-group-sm" role="group" id="ase-direction-filter">
                                            <button type="button" class="btn ultra-btn-sm active" data-direction="ALL">All</button>
                                            <button type="button" class="btn ultra-btn-sm" data-direction="Bullish">Bull</button>
                                            <button type="button" class="btn ultra-btn-sm" data-direction="Bearish">Bear</button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="ultra-filter-label-sm">State:</span>
                                        <div class="btn-group btn-group-sm" role="group" id="ase-state-filter">
                                            <button type="button" class="btn ultra-btn-sm active" data-state="ALL">All</button>
                                            <button type="button" class="btn ultra-btn-sm" data-state="ACTIVE">Active</button>
                                            <button type="button" class="btn ultra-btn-sm" data-state="COMPLETED">Completed</button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 ms-auto">
                                        <input type="text" class="form-control form-control-sm ultra-input-sm" id="ase-search-trade-id" 
                                               placeholder="Search ID..." style="width: 120px;">
                                        <button class="btn ultra-btn-sm" id="ase-clear-filters" title="Clear all filters">‚úï</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LIVE SIGNALS TABLE (Pending + Active + Completed) -->
                        <div class="dashboard-card ultra-card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <h3 class="card-title mb-0 ultra-section-header" style="font-size: 0.95rem;">Signals & Trades</h3>
                                    <span id="ase-table-date" class="ultra-muted small"></span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn ultra-btn-danger" id="ase-delete-selected" disabled title="Delete selected trades">üóë Delete</button>
                                    <span class="badge rounded-pill bg-secondary small ultra-text" id="ase-table-count">0 rows</span>
                                    <button class="btn btn-sm btn-outline-light ultra-btn" id="ase-refresh-btn">Refresh</button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
                                    <table class="ultra-table" id="ase-signals-table" style="font-size: 11px;">
                                        <thead class="position-sticky top-0" style="background: rgba(25,30,60,0.95);">
                                            <tr>
                                                <th>Trade ID</th>
                                                <th>Symbol</th>
                                                <th>Status</th>
                                                <th>Dir</th>
                                                <th>Signal Time</th>
                                                <th>Entry Time</th>
                                                <th>Exit Time</th>
                                                <th>Entry</th>
                                                <th>Stop</th>
                                                <th>NoBE MFE</th>
                                                <th>BE MFE</th>
                                                <th>MAE</th>
                                                <th>Latest Event</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ase-confirmed-tbody">
                                            <tr>
                                                <td colspan="13" class="text-center ultra-muted py-3">Loading signals...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: DETAILS + SUMMARY -->
                    <div class="col-lg-5 mb-4">
                        <!-- TRADE DETAIL / LIFECYCLE PANEL -->
                        <div class="dashboard-card ultra-card ultra-panel mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title mb-0 ultra-section-header">Trade Lifecycle</h3>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge rounded-pill bg-secondary small ultra-text" id="ase-detail-status">No trade selected</span>
                                    <button type="button" class="btn btn-sm btn-outline-light ultra-btn" id="ase-lifecycle-expand" disabled>Expand</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="ase-trade-detail-placeholder" class="ultra-muted small">
                                    Select a signal from the table to view its full lifecycle journey (Entry ‚Üí BE ‚Üí MFE ‚Üí Exit).
                                </div>
                                <div id="ase-trade-detail-container" style="display: none;">
                                    <!-- JS will render the graphical lifecycle here -->
                                </div>
                                
                                <!-- Backend Data Echo (Collapsed Tool Panel) -->
                                <div class="ase-section-container">
                                    <div class="ase-section-header" id="ase-backend-echo-header"
                                         style="cursor:pointer; user-select:none;">
                                        ‚ñ∂ Backend Data Echo
                                    </div>
                                    <div id="ase-backend-echo-body" style="display:none;">
                                        <pre id="ase-backend-echo-content"
                                             style="max-height:300px; overflow-y:auto; padding:10px; background:rgba(10,10,20,0.7); color:#e2e8f0;">
                                            Loading‚Ä¶
                                        </pre>
                                        <button id="ase-backend-echo-copy"
                                            class="btn btn-sm"
                                            style="background:rgba(255,255,255,0.1); color:#e2e8f0; margin-top:6px;">
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Signal Integrity Monitor (Collapsible) -->
                                <div class="ase-diagnostics-section" style="margin-top:15px;">
                                    <h3 class="diagnosis-header" id="ase-signal-monitor-toggle"
                                        style="cursor:pointer; margin-bottom:6px; color:#3b82f6; font-size:14px;">
                                        ‚ñº Signal Integrity Monitor
                                    </h3>
                                    
                                    <div id="ase-signal-monitor-panel"
                                         style="display:none;
                                                background:rgba(8,16,32,0.85);
                                                border:1px solid rgba(59,130,246,0.2);
                                                border-radius:10px;
                                                padding:12px;
                                                max-height:240px;
                                                overflow-y:auto;
                                                white-space:pre-wrap;
                                                font-size:11px;">
                                        Loading‚Ä¶
                                    </div>
                                </div>
                                
                                <!-- Trade Lifecycle Diagnosis Section -->
                                <div class="diagnosis-section">
                                    <h3 class="diagnosis-header">‚ñº Trade Lifecycle Diagnosis</h3>
                                    <div class="diagnosis-content" style="display:none; margin-top:8px;">
                                        <h4>Ingestion Pipeline</h4>
                                        <pre id="ase-pipeline-map" class="diagnosis-pre"></pre>
                                        <hr>
                                        <h4>Raw Webhook Payload</h4>
                                        <pre id="ase-raw-payload" class="diagnosis-pre"></pre>
                                        <button class="copy-btn" onclick="copyDiagnosis('ase-raw-payload')">Copy Payload</button>
                                        <hr>
                                        <h4>Raw Database Events</h4>
                                        <pre id="ase-raw-db-events" class="diagnosis-pre"></pre>
                                        <button class="copy-btn" onclick="copyDiagnosis('ase-raw-db-events')">Copy DB Events</button>
                                        <hr>
                                        <h4>Backend Logs</h4>
                                        <pre id="ase-backend-logs" class="diagnosis-pre"></pre>
                                        <button class="copy-btn" onclick="copyDiagnosis('ase-backend-logs')">Copy Logs</button>
                                        <hr>
                                        <h4>Lifecycle Summary (Reconstructed)</h4>
                                        <pre id="ase-lifecycle-summary" class="diagnosis-pre"></pre>
                                        <hr>
                                        <h4>Discrepancy Analysis</h4>
                                        <pre id="ase-diagnosis-report" class="diagnosis-pre"></pre>
                                        <hr>
                                        <h4>Real-Time Stream Monitor</h4>
                                        <pre id="ase-stream-monitor-report" class="diagnosis-pre" style="max-height:180px;">
No stream analysis yet.
                                        </pre>
                                        <button class="copy-btn" onclick="copyDiagnosis('ase-stream-monitor-report')">Copy Stream Report</button>
                                        <hr>
                                        <button class="copy-btn" onclick="copyFullDiagnosis()">Copy Full Diagnosis Report</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- STATS SUMMARY PANEL -->
                        <div class="dashboard-card ultra-card mb-4">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">Signal & Trade Summary</h3>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Signals Today</div>
                                        <div id="ase-summary-signals-today" class="fw-semibold ultra-metric-value">0</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Confirmed Today</div>
                                        <div id="ase-summary-confirmed" class="fw-semibold ultra-metric-value">0</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Win Rate (Today)</div>
                                        <div id="ase-summary-winrate" class="fw-semibold ultra-badge-green">--%</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">Avg MFE (No BE)</div>
                                        <div id="ase-summary-avgmfe" class="fw-semibold ultra-badge-green">0.00R</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">BE Triggers</div>
                                        <div id="ase-summary-be-count" class="fw-semibold ultra-badge-amber">0</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small ultra-muted ultra-metric-label">SL Events</div>
                                        <div id="ase-summary-sl-count" class="fw-semibold ultra-badge-red">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FUTURE ANALYTICS (ROADMAP LOCKED) -->
                        <div class="dashboard-card ultra-card">
                            <div class="card-header">
                                <h3 class="card-title mb-0 ultra-section-header">Future Analytics (Roadmap Locked)</h3>
                            </div>
                            <div class="card-body">
                                <div class="ultra-muted small mb-2">Advanced analytics will unlock here as H2/H3 modules are completed.</div>
                                <ul class="small mb-0 ultra-locked">
                                    <li><span class="ultra-lock-icon">üîí</span> Execution Quality Engine (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> Signal Outcome Predictor (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> Regime Classifier (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> MFE Distribution Engine (locked)</li>
                                    <li><span class="ultra-lock-icon">üîí</span> BE Efficiency Analytics (locked)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: ALL SIGNALS - Content stays here, just swap IDs and make active -->
            <div class="tab-pane fade show active" id="tab-all-signals" role="tabpanel" aria-labelledby="all-signals-tab">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="dashboard-card ultra-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title mb-0 ultra-section-header">All Signals (Every Triangle)</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-danger" id="ase-bulk-delete-all-signals-btn" style="display: none;">
                                        üóëÔ∏è Delete Selected (<span id="ase-all-signals-selected-count">0</span>)
                                    </button>
                                    <span class="badge rounded-pill bg-primary small ultra-text" id="ase-all-signals-count">0</span>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                    <table class="ultra-table" id="ase-all-signals-table" style="font-size: 11px;">
                                        <thead class="ultra-table-header" style="position: sticky; top: 0; z-index: 10;">
                                            <tr>
                                                <th class="ultra-table-header-cell" style="width: 40px;">
                                                    <input type="checkbox" id="ase-select-all-all-signals" class="form-check-input" title="Select all">
                                                </th>
                                                <th class="ultra-table-header-cell">Trade ID</th>
                                                <th class="ultra-table-header-cell">Symbol</th>
                                                <th class="ultra-table-header-cell">Status</th>
                                                <th class="ultra-table-header-cell">Dir</th>
                                                <th class="ultra-table-header-cell">Signal Time</th>
                                                <th class="ultra-table-header-cell">Entry Time</th>
                                                <th class="ultra-table-header-cell">Exit Time</th>
                                                <th class="ultra-table-header-cell">Entry</th>
                                                <th class="ultra-table-header-cell">Stop</th>
                                                <th class="ultra-table-header-cell">NoBE MFE</th>
                                                <th class="ultra-table-header-cell">BE MFE</th>
                                                <th class="ultra-table-header-cell">MAE</th>
                                                <th class="ultra-table-header-cell">Latest Event</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ase-all-signals-tbody">
                                            <tr>
                                                <td colspan="14" class="text-center ultra-muted py-4">
                                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                    Loading all signals...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: CANCELLED SIGNALS -->
            <div class="tab-pane fade" id="tab-cancelled" role="tabpanel" aria-labelledby="cancelled-tab">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="dashboard-card ultra-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title mb-0 ultra-section-header">Cancelled Signals</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn ultra-btn-danger btn-sm" id="ase-delete-cancelled-selected" disabled title="Delete selected cancelled signals">üóë Delete</button>
                                    <span class="badge rounded-pill bg-secondary small ultra-text" id="ase-cancelled-count">0</span>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
                                    <table class="table table-sm table-dark mb-0 ultra-table" id="ase-cancelled-table" style="font-size: 11px;">
                                        <thead class="position-sticky top-0" style="background: rgba(25,30,60,0.95);">
                                            <tr>
                                                <th>Trade ID</th>
                                                <th>Symbol</th>
                                                <th>Status</th>
                                                <th>Dir</th>
                                                <th>Signal Time</th>
                                                <th>Entry Time</th>
                                                <th>Exit Time</th>
                                                <th>Entry</th>
                                                <th>Stop</th>
                                                <th>NoBE MFE</th>
                                                <th>BE MFE</th>
                                                <th>MAE</th>
                                                <th>Latest Event</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ase-cancelled-tbody">
                                            <tr>
                                                <td colspan="13" class="text-center ultra-muted py-3">Loading cancelled signals...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: SIGNAL ANALYTICS -->
            <div class="tab-pane fade" id="tab-analytics" role="tabpanel" aria-labelledby="analytics-tab">
                
                <!-- Filter Notice -->
                <div class="alert alert-info mb-4" style="font-size: 12px;">
                    <strong>üìä Analytics Filters Applied:</strong> Valid market window only (excludes weekends/holidays) + Metrics required (excludes missing data). 
                    This ensures trustworthy analytics based on computable signals only.
                </div>
                
                <div class="row">
                    
                    <!-- BLOCK 1: Overview -->
                    <div class="col-lg-12 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">üìä Overview (Computable Signals Only)</h5>
                            </div>
                            <div class="ultra-card-body">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-2">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Total Valid</div>
                                            <div id="sa-total-valid" class="ultra-stat-value">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Computable</div>
                                            <div id="sa-computable" class="ultra-stat-value text-success">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Avg NoBE MFE</div>
                                            <div id="sa-avg-nobe-mfe" class="ultra-stat-value">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Avg BE MFE</div>
                                            <div id="sa-avg-be-mfe" class="ultra-stat-value">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Avg MAE</div>
                                            <div id="sa-avg-mae" class="ultra-stat-value">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Win Proxy (‚â•1R)</div>
                                            <div id="sa-win-proxy" class="ultra-stat-value">--%</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">CONFIRMED</div>
                                            <div id="sa-status-confirmed" class="ultra-stat-value small">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">EXITED</div>
                                            <div id="sa-status-exited" class="ultra-stat-value small">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">CANCELLED</div>
                                            <div id="sa-status-cancelled" class="ultra-stat-value small">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">PENDING</div>
                                            <div id="sa-status-pending" class="ultra-stat-value small">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BLOCK 2: Distribution -->
                    <div class="col-lg-6 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">üìà MFE Distribution (Computable Only)</h5>
                            </div>
                            <div class="ultra-card-body">
                                <h6 class="ultra-muted small mb-2">NoBE MFE Buckets</h6>
                                <table class="table table-sm table-dark mb-3">
                                    <thead>
                                        <tr>
                                            <th>Bucket</th>
                                            <th class="text-end">Count</th>
                                            <th class="text-end">%</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sa-nobe-buckets">
                                        <tr><td colspan="3" class="text-center ultra-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                                
                                <h6 class="ultra-muted small mb-2">BE MFE Buckets</h6>
                                <table class="table table-sm table-dark mb-0">
                                    <thead>
                                        <tr>
                                            <th>Bucket</th>
                                            <th class="text-end">Count</th>
                                            <th class="text-end">%</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sa-be-buckets">
                                        <tr><td colspan="3" class="text-center ultra-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BLOCK 3: Direction Breakdown -->
                    <div class="col-lg-6 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">üîµüî¥ Direction Breakdown (Computable Only)</h5>
                            </div>
                            <div class="ultra-card-body">
                                <table class="table table-sm table-dark mb-0">
                                    <thead>
                                        <tr>
                                            <th>Direction</th>
                                            <th class="text-end">Count</th>
                                            <th class="text-end">Avg NoBE MFE</th>
                                            <th class="text-end">Avg BE MFE</th>
                                            <th class="text-end">Avg MAE</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sa-direction-breakdown">
                                        <tr><td colspan="5" class="text-center ultra-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BLOCK 4: Data Exclusions Transparency -->
                    <div class="col-lg-12 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">üîç Data Exclusions Transparency</h5>
                            </div>
                            <div class="ultra-card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <h6 class="ultra-muted small mb-2">Invalid Signals Excluded (by reason)</h6>
                                        <table class="table table-sm table-dark mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Reason</th>
                                                    <th class="text-end">Count</th>
                                                </tr>
                                            </thead>
                                            <tbody id="sa-invalid-excluded">
                                                <tr><td colspan="2" class="text-center ultra-muted">Loading...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="ultra-muted small mb-2">Metrics Missing Excluded</h6>
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Valid Signals Without Metrics</div>
                                            <div id="sa-metrics-missing" class="ultra-stat-value text-warning">--</div>
                                            <div class="ultra-stat-sublabel">Excluded from analytics</div>
                                        </div>
                                        <div class="alert alert-warning mt-3 mb-0" style="font-size: 11px;">
                                            <strong>Why exclude?</strong> Signals without metrics can't be analyzed for MFE/MAE. Including them would skew averages and distributions.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        <!-- /.tab-content -->
    </div>
    <!-- /.container-fluid -->

    <!-- Full-Screen Lifecycle Overlay -->
    <div id="ase-lifecycle-overlay" style="display:none; position:fixed; inset:0; background:rgba(4,10,20,0.95); z-index:1050; overflow-y:auto;">
        <div style="max-width: 1200px; margin: 30px auto; background: linear-gradient(135deg, #0a1628, #0d2240); border-radius: 16px; padding: 28px; box-shadow: 0 0 60px rgba(0,100,255,0.15); border: 1px solid rgba(59,130,246,0.25);">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 mb-1" id="ase-lifecycle-title" style="color:#e2e8f0;">Trade Journey</h2>
                    <p class="small mb-0" id="ase-lifecycle-subtitle" style="color:rgba(226,232,240,0.7);">Select a trade from the table to see its full lifecycle.</p>
                </div>
                <button type="button" class="btn btn-sm" id="ase-lifecycle-close" style="background:rgba(255,255,255,0.1); color:#e2e8f0; border:1px solid rgba(255,255,255,0.2);">‚úï Close</button>
            </div>
            
            <!-- Main R-Chart Area -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color:#3b82f6; font-weight:600; font-size:14px;">üìà MFE Journey (R-Multiple vs Time)</span>
                    <span id="ase-chart-live-indicator" style="color:#22c55e; font-size:12px;">‚óè Live</span>
                </div>
                <div id="ase-lifecycle-chart" style="background: rgba(8,16,32,0.95); border-radius: 12px; border: 1px solid rgba(59,130,246,0.2); min-height: 320px; position:relative;">
                    <!-- D3.js chart rendered here -->
                    <svg id="ase-lifecycle-svg" width="100%" height="320"></svg>
                </div>
            </div>
            
            <!-- Tab Selector -->
            <div class="mb-3 d-flex gap-2">
                <button class="btn btn-sm ultra-btn active" id="ase-tab-chart-btn" style="background:rgba(59,130,246,0.3); color:#e2e8f0; border:1px solid rgba(59,130,246,0.4);">üìà Chart</button>
                <button class="btn btn-sm ultra-btn" id="ase-tab-details-btn" style="background:rgba(255,255,255,0.1); color:#e2e8f0; border:1px solid rgba(255,255,255,0.2);">üìã Details</button>
                <button class="btn btn-sm ultra-btn" id="ase-tab-rawpay-btn" style="background:rgba(255,255,255,0.1); color:#e2e8f0; border:1px solid rgba(255,255,255,0.2);">üß© Raw Payload</button>
            </div>

            <!-- Tab Content: Chart (default visible) -->
            <div id="ase-tab-chart-content">
                <!-- Bottom Row: Events + Metrics -->
                <div class="row g-4">
                    <div class="col-md-7">
                        <div style="color:#3b82f6; font-weight:600; font-size:14px; margin-bottom:8px;">üìã Event Stream</div>
                        <div id="ase-lifecycle-events" style="background: rgba(8,16,32,0.9); border-radius: 10px; border: 1px solid rgba(59,130,246,0.15); max-height: 180px; overflow-y: auto; padding: 12px;">
                            <div style="color:rgba(226,232,240,0.5); font-size:13px;">No events loaded.</div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div style="color:#3b82f6; font-weight:600; font-size:14px; margin-bottom:8px;">üìä Trade Metrics</div>
                        <div id="ase-lifecycle-metrics" style="background: rgba(8,16,32,0.9); border-radius: 10px; border: 1px solid rgba(59,130,246,0.15); padding: 14px;">
                            <div style="color:rgba(226,232,240,0.5); font-size:13px;">No trade selected.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Details (hidden by default) -->
            <div id="ase-tab-details-content" style="display:none;">
                <div style="background: rgba(8,16,32,0.9); border-radius: 10px; border: 1px solid rgba(59,130,246,0.15); padding: 14px;">
                    <div style="color:rgba(226,232,240,0.5); font-size:13px;">Trade details will appear here.</div>
                </div>
            </div>

            <!-- Tab Content: Raw Payload (hidden by default) -->
            <div id="ase-raw-payload-panel" style="display:none; background:rgba(8,16,32,0.95); border-radius:10px; border:1px solid rgba(59,130,246,0.15); padding:14px;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color:#3b82f6; font-weight:600; font-size:14px;">üß© Raw Payload (Debug)</span>
                    <button id="ase-copy-payload-btn" class="btn btn-sm" style="background:rgba(255,255,255,0.1); color:#e2e8f0; border:1px solid rgba(255,255,255,0.2);">üìã Copy Payload</button>
                </div>
                <pre id="ase-payload-json" style="white-space:pre-wrap; font-size:12px; color:#e2e8f0; background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; max-height:360px; overflow-y:auto;">Loading...</pre>
            </div>
        </div>
    </div>

            <!-- TAB 4: DATA QUALITY -->
            <div class="tab-pane fade" id="tab-data-quality" role="tabpanel" aria-labelledby="data-quality-tab" style="min-height: 700px !important; height: auto !important; overflow-y: auto !important; padding-bottom: 24px !important;">
                <div class="row">
                    
                    <!-- BLOCK 1: Signal Validity Summary -->
                    <div class="col-lg-6 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">üìä Signal Validity Summary</h5>
                            </div>
                            <div class="ultra-card-body">
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Total Signals</div>
                                            <div id="dq-total-signals" class="ultra-stat-value">--</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Valid Signals</div>
                                            <div id="dq-valid-signals" class="ultra-stat-value text-success">--</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Invalid Signals</div>
                                            <div id="dq-invalid-signals" class="ultra-stat-value text-warning">--</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Valid %</div>
                                            <div id="dq-valid-pct" class="ultra-stat-value">--%</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="ultra-muted small mb-2">Invalid Reason Breakdown</h6>
                                    <table class="table table-sm table-dark mb-0">
                                        <thead>
                                            <tr>
                                                <th>Reason</th>
                                                <th class="text-end">Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dq-invalid-reasons">
                                            <tr><td colspan="2" class="text-center ultra-muted">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="alert alert-info mt-3 mb-0" style="font-size: 11px;">
                                    <strong>Why NO_BARS?</strong> Weekend/holiday signals are excluded because Databento has no market data for those times. This prevents false metrics.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BLOCK 2: Metrics Availability -->
                    <div class="col-lg-6 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">üìà Metrics Availability (Valid Signals Only)</h5>
                            </div>
                            <div class="ultra-card-body">
                                <div class="row g-3 mb-3">
                                    <div class="col-4">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Event Metrics</div>
                                            <div id="dq-event-metrics" class="ultra-stat-value text-success">--</div>
                                            <div class="ultra-stat-sublabel">Real-time</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Computed Metrics</div>
                                            <div id="dq-computed-metrics" class="ultra-stat-value text-info">--</div>
                                            <div class="ultra-stat-sublabel">Databento</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Missing Metrics</div>
                                            <div id="dq-missing-metrics" class="ultra-stat-value text-danger">--</div>
                                            <div class="ultra-stat-sublabel">No data</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="ultra-muted small mb-2">Metrics Coverage</h6>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div id="dq-event-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                                            <span id="dq-event-bar-label">0%</span>
                                        </div>
                                        <div id="dq-computed-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%">
                                            <span id="dq-computed-bar-label">0%</span>
                                        </div>
                                        <div id="dq-missing-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%">
                                            <span id="dq-missing-bar-label">0%</span>
                                        </div>
                                    </div>
                                    <div class="small ultra-muted">
                                        <span class="badge bg-success">Event</span> = Real-time from indicator | 
                                        <span class="badge bg-info">Computed</span> = Backfilled from Databento | 
                                        <span class="badge bg-danger">Missing</span> = No data available
                                    </div>
                                </div>
                                
                                <div class="alert alert-success mt-3 mb-0" style="font-size: 11px;">
                                    <strong>Goal:</strong> 100% of valid signals should have metrics (event or computed). Missing metrics indicate data pipeline issues.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BLOCK 3: Lifecycle Completeness Checks -->
                    <div class="col-lg-12 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">‚úÖ Lifecycle Completeness Checks (Valid Signals Only)</h5>
                            </div>
                            <div class="ultra-card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card" id="dq-check-1">
                                            <div class="ultra-stat-label">EXITED Missing Exit Time</div>
                                            <div id="dq-exited-no-exit" class="ultra-stat-value">--</div>
                                            <div class="ultra-stat-sublabel">Should be 0</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card" id="dq-check-2">
                                            <div class="ultra-stat-label">CONFIRMED Missing Entry/Stop</div>
                                            <div id="dq-confirmed-no-entry" class="ultra-stat-value">--</div>
                                            <div class="ultra-stat-sublabel">Should be 0</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card" id="dq-check-3">
                                            <div class="ultra-stat-label">PENDING With Entry</div>
                                            <div id="dq-pending-with-entry" class="ultra-stat-value">--</div>
                                            <div class="ultra-stat-sublabel">Should be 0</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card" id="dq-check-4">
                                            <div class="ultra-stat-label">CANCELLED With Entry</div>
                                            <div id="dq-cancelled-with-entry" class="ultra-stat-value">--</div>
                                            <div class="ultra-stat-sublabel">Should be 0</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="ultra-muted small mb-2">Lifecycle Integrity Status</h6>
                                    <div id="dq-lifecycle-status" class="alert alert-secondary mb-0">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            <span>Checking lifecycle integrity...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BLOCK 4: Market Coverage Spot Check -->
                    <div class="col-lg-12 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">üóìÔ∏è Market Coverage Spot Check</h5>
                            </div>
                            <div class="ultra-card-body">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Earliest Signal</div>
                                            <div id="dq-earliest-signal" class="ultra-stat-value small">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Latest Signal</div>
                                            <div id="dq-latest-signal" class="ultra-stat-value small">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Signals Missing Time</div>
                                            <div id="dq-missing-time" class="ultra-stat-value">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="ultra-stat-card">
                                            <div class="ultra-stat-label">Coverage Days</div>
                                            <div id="dq-coverage-days" class="ultra-stat-value">--</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mb-0" style="font-size: 11px;">
                                    <strong>Coverage Check:</strong> If "Signals Missing Time" is high, there may be data ingestion issues. All signals should have signal_bar_open_ts populated.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
                        </div>
                    </div>

                    <!-- Conflicts List -->
                    <div class="col-lg-12 mb-4">
                        <div class="ultra-card">
                            <div class="ultra-card-header">
                                <h5 class="ultra-card-title">‚ö†Ô∏è Conflicts Requiring Review</h5>
                            </div>
                            <div class="ultra-card-body">
                                <div id="dq-conflicts-list">
                                    <div class="text-center ultra-muted py-4">No conflicts detected</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/automated_signals_ultra.js') }}?v={{ build_ts }}"></script>
{% endblock %}

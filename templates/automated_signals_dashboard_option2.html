<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimalist Trader's Cockpit | Automated Signals</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            color: #1e293b;
            min-height: 100vh;
        }

        /* Header Bar */
        .header-bar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .header-label {
            color: #64748b;
            font-weight: 500;
        }

        .header-value {
            color: #1e293b;
            font-weight: 600;
        }

        .status-active {
            color: #ef4444;
        }

        .status-complete {
            color: #10b981;
        }

        /* Main Grid */
        .main-grid {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Trade Cards */
        .trade-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .trade-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .trade-id {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            letter-spacing: 0.5px;
        }

        .trade-direction {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .direction-long {
            background: #dcfce7;
            color: #166534;
        }

        .direction-short {
            background: #fee2e2;
            color: #991b1b;
        }

        .trade-mfe {
            font-size: 28px;
            font-weight: 700;
            margin: 8px 0;
        }

        .mfe-positive {
            color: #10b981;
        }

        .mfe-negative {
            color: #ef4444;
        }

        .trade-details {
            font-size: 12px;
            color: #64748b;
            line-height: 1.6;
        }

        .chart-mini {
            height: 60px;
            margin: 12px 0;
        }

        .trade-duration {
            font-size: 11px;
            color: #94a3b8;
            text-align: right;
        }

        /* Calendar Section */
        .calendar-card {
            grid-column: span 3;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .calendar-title {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(14, 1fr);
            gap: 8px;
        }

        .calendar-hour {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-hour:hover {
            transform: scale(1.1);
        }

        .hour-label {
            color: #64748b;
            margin-bottom: 2px;
        }

        .hour-count {
            font-size: 14px;
            font-weight: 700;
        }

        /* Timeline Section */
        .timeline-card {
            grid-column: span 3;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .timeline-title {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timeline-container {
            position: relative;
            height: 200px;
        }

        .timeline-axis {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: #e2e8f0;
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #94a3b8;
        }

        .timeline-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeline-bar:hover {
            transform: scaleY(1.2);
            z-index: 10;
        }

        .bar-be {
            background: #10b981;
        }

        .bar-sl {
            background: #ef4444;
        }

        /* Distribution Chart */
        .distribution-card {
            grid-column: span 3;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .distribution-title {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            height: 250px;
        }

        /* Pulse Animation for Active Trades */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .dot-green {
            background: #10b981;
        }

        .dot-yellow {
            background: #f59e0b;
        }

        .dot-red {
            background: #ef4444;
        }

        /* Completed Trades Section */
        .completed-section {
            grid-column: span 3;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .completed-title {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .completed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .completed-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }

        .completed-item.sl {
            border-left-color: #ef4444;
        }

        .completed-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .completed-id {
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
        }

        .completed-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #dcfce7;
            color: #166534;
        }

        .completed-mfe {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .completed-details {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- Header Bar -->
    <div class="header-bar">
        <div class="header-left">
            <div class="header-item">
                <span class="header-label">üìÖ</span>
                <span class="header-value" id="currentDate">Nov 9, 2025</span>
            </div>
            <div class="header-item">
                <span class="header-label">üïê</span>
                <span class="header-value" id="currentTime">14:32:15 EST</span>
            </div>
            <div class="header-item">
                <span class="header-label">üî¥ Active:</span>
                <span class="header-value status-active" id="activeCount">0</span>
            </div>
            <div class="header-item">
                <span class="header-label">‚úÖ Complete:</span>
                <span class="header-value status-complete" id="completeCount">0</span>
            </div>
        </div>
        <div class="header-item">
            <span class="header-label">üì∞ Next Event:</span>
            <span class="header-value" id="nextEvent">Loading...</span>
        </div>
        <div class="header-item">
            <span class="header-label">üéØ Avg MFE:</span>
            <span class="header-value" id="avgMfe">0.00R</span>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
        <!-- Active Trades (will be populated dynamically) -->
        <div id="activeTradesContainer"></div>

        <!-- Calendar Heatmap -->
        <div class="calendar-card">
            <div class="calendar-title">üìÖ Daily Trading Calendar</div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- Timeline -->
        <div class="timeline-card">
            <div class="timeline-title">‚è±Ô∏è Completed Trades Timeline</div>
            <div class="timeline-container" id="timelineContainer">
                <div class="timeline-axis"></div>
            </div>
            <div class="timeline-labels">
                <span>6 AM</span>
                <span>8 AM</span>
                <span>10 AM</span>
                <span>12 PM</span>
                <span>2 PM</span>
                <span>4 PM</span>
                <span>6 PM</span>
            </div>
        </div>

        <!-- MFE Distribution -->
        <div class="distribution-card">
            <div class="distribution-title">üìä MFE Distribution</div>
            <div class="chart-container">
                <canvas id="mfeDistributionChart"></canvas>
            </div>
        </div>

        <!-- Completed Trades -->
        <div class="completed-section">
            <div class="completed-title">‚úÖ Completed Trades (Database Verified)</div>
            <div class="completed-grid" id="completedGrid"></div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'America/New_York'
            }) + ' EST';
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Generate calendar heatmap
        function generateCalendar() {
            const container = document.getElementById('calendarGrid');
            const hours = ['6AM', '7AM', '8AM', '9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM'];
            
            hours.forEach((hour, index) => {
                const hourDiv = document.createElement('div');
                hourDiv.className = 'calendar-hour';
                hourDiv.style.background = '#f1f5f9';
                hourDiv.innerHTML = `
                    <div class="hour-label">${hour}</div>
                    <div class="hour-count">0</div>
                `;
                container.appendChild(hourDiv);
            });
        }

        // Create active trade card
        function createActiveTradeCard(trade) {
            const mfeValue = parseFloat(trade.current_mfe || 0);
            const mfeClass = mfeValue >= 0 ? 'mfe-positive' : 'mfe-negative';
            const directionClass = trade.bias === 'Bullish' ? 'direction-long' : 'direction-short';
            
            return `
                <div class="trade-card pulse">
                    <div class="trade-header">
                        <div class="trade-id">TRADE_${trade.id}</div>
                        <div class="trade-direction ${directionClass}">${trade.bias === 'Bullish' ? 'LONG' : 'SHORT'}</div>
                    </div>
                    <div class="trade-mfe ${mfeClass}">+${mfeValue.toFixed(2)}R</div>
                    <div class="trade-details">
                        Entry: ${trade.entry_price || 'N/A'}<br>
                        SL: ${trade.stop_loss || 'N/A'}<br>
                        Session: ${trade.session || 'N/A'}
                    </div>
                    <div class="chart-mini">
                        <canvas id="chart_${trade.id}"></canvas>
                    </div>
                    <div class="trade-duration">${trade.duration || '0m 0s'}</div>
                </div>
            `;
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('/api/automated-signals/stats');
                const data = await response.json();
                
                // Update header stats
                document.getElementById('activeCount').textContent = data.active_count || 0;
                document.getElementById('completeCount').textContent = data.completed_count || 0;
                document.getElementById('avgMfe').textContent = (data.avg_mfe || 0).toFixed(2) + 'R';
                
                // Render active trades
                const container = document.getElementById('activeTradesContainer');
                if (data.active_trades && data.active_trades.length > 0) {
                    container.innerHTML = data.active_trades.map(createActiveTradeCard).join('');
                }
                
                // Render completed trades
                renderCompletedTrades(data.completed_trades || []);
                
                // Update calendar
                updateCalendar(data.hourly_distribution || {});
                
                // Update timeline
                updateTimeline(data.completed_trades || []);
                
                // Update distribution chart
                updateDistributionChart(data.mfe_distribution || []);
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function renderCompletedTrades(trades) {
            const grid = document.getElementById('completedGrid');
            grid.innerHTML = trades.slice(0, 20).map(trade => `
                <div class="completed-item ${trade.exit_reason === 'SL' ? 'sl' : ''}">
                    <div class="completed-header">
                        <div class="completed-id">T${trade.id}</div>
                        <div class="completed-badge">‚úì DB</div>
                    </div>
                    <div class="completed-mfe">${(trade.mfe || 0).toFixed(2)}R</div>
                    <div class="completed-details">
                        ${trade.exit_reason || 'BE'} | ${trade.duration || 'N/A'}
                    </div>
                </div>
            `).join('');
        }

        function updateCalendar(distribution) {
            const hours = document.querySelectorAll('.calendar-hour');
            hours.forEach((hour, index) => {
                const count = distribution[index + 6] || 0;
                const intensity = Math.min(count / 5, 1);
                hour.style.background = `rgba(37, 99, 235, ${0.1 + intensity * 0.9})`;
                hour.querySelector('.hour-count').textContent = count;
            });
        }

        function updateTimeline(trades) {
            const container = document.getElementById('timelineContainer');
            const existingBars = container.querySelectorAll('.timeline-bar');
            existingBars.forEach(bar => bar.remove());
            
            trades.slice(0, 10).forEach((trade, index) => {
                const bar = document.createElement('div');
                bar.className = `timeline-bar ${trade.exit_reason === 'SL' ? 'bar-sl' : 'bar-be'}`;
                bar.style.left = '10%';
                bar.style.width = '15%';
                bar.style.bottom = `${30 + index * 15}px`;
                bar.textContent = `${(trade.mfe || 0).toFixed(1)}R`;
                container.appendChild(bar);
            });
        }

        function updateDistributionChart(distribution) {
            const ctx = document.getElementById('mfeDistributionChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-0.5R', '0.5-1R', '1-1.5R', '1.5-2R', '2-2.5R', '2.5-3R', '3R+'],
                    datasets: [{
                        label: 'Trade Count',
                        data: distribution,
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#e2e8f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Initialize
        generateCalendar();
        loadData();
        setInterval(loadData, 5000);

        // WebSocket listeners
        socket.on('mfe_update', (data) => {
            console.log('MFE Update:', data);
            loadData();
        });

        socket.on('trade_completed', (data) => {
            console.log('Trade Completed:', data);
            loadData();
        });
    </script>
</body>
</html>

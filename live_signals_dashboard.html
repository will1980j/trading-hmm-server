<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Signal Dashboard - FVG/IFVG Real-time Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #fff;
            overflow-x: hidden;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }
        
        .header {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            backdrop-filter: blur(10px);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        
        .main-content {
            display: grid;
            grid-template-rows: 200px 1fr;
            gap: 10px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .metric-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
        }
        
        .signals-container {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        
        .analysis-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        
        .signals-table-container {
            overflow-y: auto;
            max-height: 400px;
        }
        
        .signals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .signals-table th {
            background: rgba(255,255,255,0.1);
            padding: 8px 4px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 0;
        }
        
        .signals-table td {
            padding: 8px 4px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            vertical-align: top;
        }
        
        .signals-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .signal-bullish { color: #00ff88; }
        .signal-bearish { color: #ff4757; }
        .signal-neutral { color: #ffa502; }
        
        .divergence-signal {
            background: rgba(255, 215, 0, 0.1) !important;
            border-left: 3px solid #FFD700;
        }
        
        .divergence-signal:hover {
            background: rgba(255, 215, 0, 0.2) !important;
        }
        
        .no-signals {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
            font-style: italic;
        }
        
        .timeframe-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .timeframe-tab {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .timeframe-tab.active {
            background: #00ff88;
            color: #000;
        }
        
        .correlation-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .correlation-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 12px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-live { background: #00ff88; animation: pulse 2s infinite; }
        .status-offline { background: #ff4757; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .ai-analysis {
            background: rgba(0,255,136,0.1);
            border: 1px solid rgba(0,255,136,0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .strength-meter {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ffa502, #00ff88);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Live Signal Dashboard</h1>
            <div>
                <span class="status-indicator status-live"></span>
                <span>Live Feed Active</span>
                <span style="margin-left: 20px; font-size: 14px;" id="lastUpdate">Last: --:--</span>
            </div>
        </div>
        
        <div class="sidebar">
            <h3>Timeframes</h3>
            <div class="timeframe-tabs">
                <button class="timeframe-tab active" onclick="switchTimeframe('1m')">1M</button>
                <button class="timeframe-tab" onclick="switchTimeframe('5m')">5M</button>
                <button class="timeframe-tab" onclick="switchTimeframe('15m')">15M</button>
                <button class="timeframe-tab" onclick="switchTimeframe('1h')">1H</button>
            </div>
            
            <h3>Symbol Correlations</h3>
            <div class="correlation-matrix" id="correlationMatrix">
                <div class="correlation-item">
                    <div>NQ vs ES</div>
                    <div style="color: #00ff88;">+0.87</div>
                </div>
                <div class="correlation-item">
                    <div>NQ vs YM</div>
                    <div style="color: #ffa502;">+0.65</div>
                </div>
                <div class="correlation-item">
                    <div>NQ vs RTY</div>
                    <div style="color: #ff4757;">-0.23</div>
                </div>
            </div>
            
            <h3>Signal Filters</h3>
            <div style="margin: 10px 0;">
                <label><input type="checkbox" checked> Bullish FVG</label><br>
                <label><input type="checkbox" checked> Bearish FVG</label><br>
                <label><input type="checkbox" checked> Bullish IFVG</label><br>
                <label><input type="checkbox" checked> Bearish IFVG</label><br>
                <label><input type="checkbox" checked> ATH/ATL Bias</label>
            </div>
        </div>
        
        <div class="main-content">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalSignals">0</div>
                    <div class="metric-label">Total Signals</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="bullishSignals">0</div>
                    <div class="metric-label">Bullish</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="bearishSignals">0</div>
                    <div class="metric-label">Bearish</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="signalStrength">--</div>
                    <div class="metric-label">Avg Strength</div>
                </div>
            </div>
            
            <div class="signals-container">
                <h3>Live Signals Feed</h3>
                <div class="signals-table-container">
                    <table class="signals-table" id="signalsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Triangle Bias</th>
                                <th>HTF Status</th>
                                <th>Price</th>
                                <th>Strength</th>
                                <th>NQ Context</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="signalsFeed">
                            <!-- Signals will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="analysis-panel">
            <h3>🤖 AI Analysis</h3>
            <div class="ai-analysis" id="aiAnalysis">
                <div>Analyzing signal patterns...</div>
            </div>
            
            <h3>Signal Strength</h3>
            <div style="margin: 10px 0;">
                <div>Current Signal</div>
                <div class="strength-meter">
                    <div class="strength-fill" style="width: 0%" id="strengthMeter"></div>
                </div>
                <div style="font-size: 12px; opacity: 0.7;" id="strengthText">No active signal</div>
            </div>
            
            <h3>Level 2 Data</h3>
            <div id="level2Data" style="font-size: 12px; line-height: 1.4;">
                <div>Bid/Ask Spread: --</div>
                <div>Volume Imbalance: --</div>
                <div>Order Flow: --</div>
            </div>
            
            <h3>Divergence Alerts</h3>
            <div id="divergenceAlerts">
                <div style="font-size: 12px; opacity: 0.7;">No institutional divergences detected</div>
            </div>
        </div>
    </div>

    <script>
        let currentTimeframe = '1m';
        let signals = [];
        let wsConnection = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            signals = []; // Clear any cached data
            initializeWebSocket();
            loadHistoricalSignals();
            startMetricsUpdate();
        });
        
        // WebSocket connection for real-time signals
        function initializeWebSocket() {
            try {
                // Connect to SocketIO
                const socket = io();
                
                socket.on('connect', function() {
                    console.log('WebSocket connected');
                    updateConnectionStatus(true);
                });
                
                socket.on('disconnect', function() {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus(false);
                });
                
                socket.on('new_signal', function(signal) {
                    console.log('New signal received:', signal);
                    addNewSignal(signal);
                    updateMetrics();
                    updateAIAnalysis();
                });
                
                // Fallback polling every 60 seconds
                setInterval(loadHistoricalSignals, 60000);
                
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                updateConnectionStatus(false);
                // Fallback to polling
                setInterval(loadHistoricalSignals, 10000);
            }
        }
        
        // Load historical signals
        async function loadHistoricalSignals() {
            try {
                const response = await fetch('/api/live-signals?timeframe=' + currentTimeframe, {
                    timeout: 5000
                });
                if (!response.ok) throw new Error('Network response not ok');
                const data = await response.json();
                
                // Merge with existing signals to maintain persistence
                const newSignals = data.signals || [];
                const existingIds = signals.map(s => s.id);
                const uniqueNewSignals = newSignals.filter(s => !existingIds.includes(s.id));
                
                signals = [...uniqueNewSignals, ...signals].slice(0, 100);
                
                updateSignalsFeed();
                updateMetrics();
                updateLastUpdateTime();
            } catch (error) {
                // Silently handle errors to reduce console spam
                updateSignalsFeed();
                updateMetrics();
            }
        }
        
        // Add new signal to feed
        function addNewSignal(signal) {
            // Remove any existing signal with same ID to prevent duplicates
            signals = signals.filter(s => s.id !== signal.id);
            
            signals.unshift(signal);
            if (signals.length > 50) {
                signals = signals.slice(0, 50); // Keep last 50 signals for better performance
            }
            updateSignalsFeed();
            updateLastUpdateTime();
            
            // Highlight new signal briefly
            setTimeout(() => {
                const newSignalElement = document.querySelector('.signal-item');
                if (newSignalElement) {
                    newSignalElement.style.backgroundColor = 'rgba(0,255,136,0.2)';
                    setTimeout(() => {
                        newSignalElement.style.backgroundColor = '';
                    }, 2000);
                }
            }, 100);
        }
        
        // Update signals feed display
        function updateSignalsFeed() {
            const feed = document.getElementById('signalsFeed');
            
            if (!signals || signals.length === 0) {
                feed.innerHTML = '<tr><td colspan="8" class="no-signals">No signals yet. Waiting for TradingView alerts...</td></tr>';
                return;
            }
            
            feed.innerHTML = signals.map(signal => createSignalRow(signal)).join('');
        }
        
        // Create signal table row
        function createSignalRow(signal) {
            const bias = signal.bias || 'Neutral';
            const biasClass = `signal-${bias.toLowerCase()}`;
            
            // Check if this is a divergence signal
            const isDivergence = signal.signal_type && signal.signal_type.includes('DIVERGENCE');
            
            // Show triangle direction with arrow and details
            const arrow = bias === 'Bullish' ? '▲' : bias === 'Bearish' ? '▼' : '◆';
            let signalDetail = signal.fvg_detail || signal.signal_type || 'FVG';
            
            // Special handling for divergence signals
            if (isDivergence) {
                const divType = signal.signal_type.replace('DIVERGENCE_', '');
                signalDetail = `${divType} DIV`;
            }
            
            const triangleDisplay = `
                <div class="${biasClass}"><strong>${arrow} ${bias.toUpperCase()}</strong></div>
                <div style="font-size: 10px; opacity: 0.8;">
                    ${signalDetail}<br>
                    ${Math.round(signal.strength || 0)}%
                </div>
            `;
            
            // HTF Status display
            const htfStatus = signal.htf_status || '--';
            const htfAligned = signal.htf_aligned;
            const htfDisplay = htfAligned ? 
                `<div style="color: #00ff88; font-size: 10px;">✓ ALIGNED<br>${htfStatus}</div>` :
                `<div style="color: #ffa502; font-size: 10px;">⚠ PARTIAL<br>${htfStatus}</div>`;
            
            // NQ Context based on symbol and bias
            let nqContext = '';
            const symbol = signal.symbol || '';
            
            if (symbol.includes('NQ')) {
                nqContext = bias === 'Bullish' ? '🟢 Direct Long' : '🔴 Direct Short';
            } else if (symbol.includes('DXY')) {
                nqContext = bias === 'Bullish' ? '🔴 NQ Bearish' : '🟢 NQ Bullish';
            } else if (symbol.includes('ES') || symbol.includes('YM')) {
                nqContext = bias === 'Bullish' ? '🟢 NQ Bullish' : '🔴 NQ Bearish';
            } else if (symbol.includes('RTY')) {
                nqContext = bias === 'Bullish' ? '🟡 NQ Neutral' : '🟡 NQ Neutral';
            } else {
                nqContext = '⚪ Monitor';
            }
            
            // Action based on context
            let action = '';
            if (symbol.includes('NQ')) {
                action = bias === 'Bullish' ? 'Long FVG' : 'Short FVG';
            } else if (symbol.includes('DXY')) {
                action = bias === 'Bullish' ? 'Wait NQ Short' : 'Prep NQ Long';
            } else if (symbol.includes('ES') || symbol.includes('YM')) {
                action = bias === 'Bullish' ? 'Check NQ Long' : 'Check NQ Short';
            } else {
                action = 'Monitor';
            }
            
            // Add special styling for divergence signals
            const rowClass = isDivergence ? `${biasClass} divergence-signal` : biasClass;
            
            return `
                <tr class="${rowClass}">
                    <td>${formatTime(signal.timestamp)}</td>
                    <td><strong>${signal.symbol || 'N/A'}</strong></td>
                    <td>${triangleDisplay}</td>
                    <td>${htfDisplay}</td>
                    <td>${signal.price || 0}</td>
                    <td>${Math.round(signal.strength || 0)}%</td>
                    <td style="font-size: 11px;">${nqContext}</td>
                    <td style="font-size: 11px; font-weight: bold;">${action}</td>
                </tr>
            `;
        }
        
        // Update metrics
        function updateMetrics() {
            const total = signals.length;
            const bullish = signals.filter(s => s.bias === 'Bullish').length;
            const bearish = signals.filter(s => s.bias === 'Bearish').length;
            const avgStrength = signals.length > 0 ? 
                (signals.reduce((sum, s) => sum + s.strength, 0) / signals.length).toFixed(1) : '--';
            
            document.getElementById('totalSignals').textContent = total;
            document.getElementById('bullishSignals').textContent = bullish;
            document.getElementById('bearishSignals').textContent = bearish;
            document.getElementById('signalStrength').textContent = avgStrength + '%';
        }
        
        // Switch timeframe
        function switchTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update active tab
            document.querySelectorAll('.timeframe-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload signals for new timeframe
            loadHistoricalSignals();
        }
        
        // Update AI analysis
        async function updateAIAnalysis() {
            if (signals.length < 5) return;
            
            try {
                const response = await fetch('/api/ai-signal-analysis-live', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        signals: signals.slice(0, 20),
                        timeframe: currentTimeframe 
                    })
                });
                
                const data = await response.json();
                document.getElementById('aiAnalysis').innerHTML = `
                    <div><strong>Pattern Recognition:</strong></div>
                    <div>${data.pattern || 'Analyzing...'}</div>
                    <div style="margin-top: 10px;"><strong>Recommendation:</strong></div>
                    <div>${data.recommendation || 'Processing...'}</div>
                `;
            } catch (error) {
                console.error('AI analysis error:', error);
            }
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const indicator = document.querySelector('.status-indicator');
            const text = indicator.nextElementSibling;
            
            if (connected) {
                indicator.className = 'status-indicator status-live';
                text.textContent = 'Live Feed Active';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Polling for Signals';
            }
        }
        
        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                timeZone: 'America/New_York',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `Last: ${timeString}`;
        }
        
        // Format timestamp to match TradingView exchange time (EST/EDT)
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                timeZone: 'America/New_York', // Automatically handles EST (-5) / EDT (-4)
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Start metrics update interval
        function startMetricsUpdate() {
            setInterval(() => {
                updateCorrelations();
                updateLevel2Data();
                checkDivergences();
            }, 30000);
        }
        
        // Update correlations from API
        async function updateCorrelations() {
            try {
                const response = await fetch('/api/signal-correlations', {
                    timeout: 3000
                });
                if (!response.ok) return;
                const data = await response.json();
                
                if (data.correlations && data.correlations.length > 0) {
                    const matrix = document.getElementById('correlationMatrix');
                    matrix.innerHTML = data.correlations.slice(0, 3).map(corr => {
                        const strength = parseFloat(corr.avg_strength) || 0;
                        return `
                            <div class="correlation-item">
                                <div>${corr.symbol || 'N/A'}</div>
                                <div style="color: ${strength > 70 ? '#00ff88' : strength > 50 ? '#ffa502' : '#ff4757'};">
                                    ${strength.toFixed(1)}%
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                // Silent error handling
            }
        }
        
        // Update Level 2 data from provider
        function updateLevel2Data() {
            // Real Level 2 data would come from level2_provider
            document.getElementById('level2Data').innerHTML = `
                <div>Bid/Ask Spread: --</div>
                <div>Volume Imbalance: --</div>
                <div>Order Flow: --</div>
            `;
        }
        
        // Check for divergences from API
        async function checkDivergences() {
            try {
                const response = await fetch('/api/signal-correlations');
                const data = await response.json();
                const alertsDiv = document.getElementById('divergenceAlerts');
                
                if (data.divergences && data.divergences.length > 0) {
                    alertsDiv.innerHTML = data.divergences.map(div => `
                        <div style="color: #ff4757; font-weight: bold; margin-bottom: 8px;">
                            ${div.message}<br>
                            <small style="opacity: 0.8;">${div.interpretation}</small>
                        </div>
                    `).join('');
                } else {
                    alertsDiv.innerHTML = `
                        <div style="font-size: 12px; opacity: 0.7;">No institutional divergences detected</div>
                    `;
                }
            } catch (error) {
                const alertsDiv = document.getElementById('divergenceAlerts');
                if (alertsDiv) {
                    alertsDiv.innerHTML = `
                        <div style="font-size: 12px; opacity: 0.7;">No divergences detected</div>
                    `;
                }
            }
        }
    </script>
</body>
</html>